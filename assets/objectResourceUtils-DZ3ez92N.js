const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/loader-BRah9kOb.js","assets/index-CfYeSufM.js","assets/resourceUtils-B2WDZGL5.js"])))=>i.map(i=>d[i]);
import{pa as ae,pb as ie,pc as I,lk as X,ll as D,pd as le,pe as ue,_ as ce,pf as fe,cC as de,cy as me,bu as L,iw as q,f$ as pe,pg as U,g2 as xe,fo as he,ou as Te,m2 as Y,ph as Z,fl as ge,oV as P,fm as W,mo as ee,pi as A,pj as be,pk as ye,oW as we,pl as z,oX as G,pm as Re,fJ as _,mn as $e,eD as B,fD as S,m5 as ve,m6 as Be,m7 as H,m8 as J,m9 as Se,pn as Me,po as Ae,pp as K,pq as Ee,pr as Oe,fB as _e,kF as Fe,ps as Ie,pt as Le}from"./index-CfYeSufM.js";import{a as Ce}from"./devEnvironmentUtils-CnNDiFMM.js";import{o as Pe,d as Q}from"./vec4-CjBq_Rau.js";import{o as je,n as Ve}from"./indexUtils-U4gn_RPI.js";import{n as C}from"./resourceUtils-B2WDZGL5.js";function M(t){if(t==null)return null;const r=t.offset!=null?t.offset:ae,o=t.rotation!=null?t.rotation:0,s=t.scale!=null?t.scale:ie,c=I(1,0,0,0,1,0,r[0],r[1],1),d=I(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),i=I(s[0],0,0,0,s[1],0,0,0,1),l=X();return D(l,d,i),D(l,c,l),l}class ke{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class Ne{constructor(r,o,s){this.name=r,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new ke,this.numberOfVertices=0}}async function De(t,r){var u;const o=te(Ce(t));if(o.fileType==="wosr"){const m=await(r.cache?r.cache.loadWOSR(o.url,r):le(o.url,r)),{engineResources:p,referenceBoundingBox:f}=ue(m,r);return{lods:p,referenceBoundingBox:f,isEsriSymbolResource:!1,isWosr:!0}}let s;if(r.cache)s=await r.cache.loadGLTF(o.url,r,!!r.usePBR);else{const{loadGLTF:m}=await ce(()=>import("./loader-BRah9kOb.js"),__vite__mapDeps([0,1,2]));s=await m(new fe(r.streamDataRequester),o.url,r,r.usePBR)}const c=(u=s.model.meta)==null?void 0:u.ESRI_proxyEllipsoid,d=s.meta.isEsriSymbolResource&&c!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";d&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,Ge(s,c));const i=!!r.usePBR,l=s.meta.isEsriSymbolResource?{usePBR:i,isSchematic:!1,treeRendering:d,mrrFactors:Ie}:{usePBR:i,isSchematic:!1,treeRendering:!1,mrrFactors:Le},e={...r.materialParameters,treeRendering:d},{engineResources:n,referenceBoundingBox:a}=qe(s,l,e,r,o.specifiedLodIndex);return{lods:n,referenceBoundingBox:a,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function te(t){const r=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return r?{fileType:"gltf",url:r[1],specifiedLodIndex:r[4]!=null?Number(r[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function qe(t,r,o,s,c){const d=t.model,i=new Array,l=new Map,e=new Map,n=d.lods.length,a=ge();return d.lods.forEach((u,m)=>{const p=s.skipHighLods===!0&&(n>1&&m===0||n>3&&m===1)||s.skipHighLods===!1&&c!=null&&m!==c;if(p&&m!==0)return;const f=new Ne(u.name,u.lodThreshold,[0,0,0]);u.parts.forEach(T=>{const h=p?new P({},s):Ue(d,T,f,r,o,l,e,s),{geometry:b,vertexCount:y}=We(T,h??new P({},s)),g=b.boundingInfo;g!=null&&m===0&&(W(a,g.bbMin),W(a,g.bbMax)),h!=null&&(f.stageResources.geometries.push(b),f.numberOfVertices+=y)}),p||i.push(f)}),{engineResources:i,referenceBoundingBox:a}}function Ue(t,r,o,s,c,d,i,l){var y,g;const e=t.materials.get(r.material);if(e==null)return null;const{normal:n,color:a,texCoord0:u,tangent:m}=r.attributes,p=r.material+(n?"_normal":"")+(a?"_color":"")+(u?"_texCoord0":"")+(m?"_tangent":""),f=r.attributes.texCoord0!=null,T=r.attributes.normal!=null,h=ze(e.alphaMode);if(!d.has(p)){if(f){const v=(O,ne=!1)=>{if(O!=null&&!i.has(O)){const F=t.textures.get(O);if(F){const w=F.data;i.set(O,new Fe(C(w)?w.data:w,{...F.parameters,preMultiplyAlpha:!C(w)&&ne,encoding:C(w)?w.encoding:void 0}))}}};v(e.colorTexture,h!==A.Opaque),v(e.normalTexture),v(e.occlusionTexture),v(e.emissiveTexture),v(e.metallicRoughnessTexture)}const x=1/ee,$=e.color[0]**x,j=e.color[1]**x,V=e.color[2]**x,re=e.emissiveFactor[0]**x,se=e.emissiveFactor[1]**x,oe=e.emissiveFactor[2]**x,E=e.colorTexture!=null&&f?i.get(e.colorTexture):null,k=be(e),N=((y=e.normalTextureTransform)==null?void 0:y.scale)!=null?(g=e.normalTextureTransform)==null?void 0:g.scale:ye;d.set(p,new P({...s,transparent:h===A.Blend,customDepthTest:Re.Lequal,textureAlphaMode:h,textureAlphaCutoff:e.alphaCutoff,diffuse:[$,j,V],ambient:[$,j,V],opacity:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?G.None:G.Back,hasVertexColors:!!r.attributes.color,hasVertexTangents:!!r.attributes.tangent,normalType:T?z.Attribute:z.ScreenDerivative,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclustion,textureId:E!=null?E.id:void 0,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&f?i.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:E!=null&&!!E.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&f?i.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&f?i.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&f?i.get(e.metallicRoughnessTexture).id:void 0,emissiveFactor:[re,se,oe],mrrFactors:k?we:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:k,colorTextureTransformMatrix:M(e.colorTextureTransform),normalTextureTransformMatrix:M(e.normalTextureTransform),scale:[N[0],N[1]],occlusionTextureTransformMatrix:M(e.occlusionTextureTransform),emissiveTextureTransformMatrix:M(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:M(e.metallicRoughnessTextureTransform),...c},l))}const b=d.get(p);if(o.stageResources.materials.push(b),f){const x=$=>{$!=null&&o.stageResources.textures.push(i.get($))};x(e.colorTexture),x(e.normalTexture),x(e.occlusionTexture),x(e.emissiveTexture),x(e.metallicRoughnessTexture)}return b}function We(t,r){const o=t.attributes.position.count,s=je(t.indices||o,t.primitiveType),c=_(3*o),{typedBuffer:d,typedBufferStride:i}=t.attributes.position;$e(c,d,t.transform,3,i);const l=[[B.POSITION,new S(c,s,3,!0)]];if(t.attributes.normal!=null){const n=_(3*o),{typedBuffer:a,typedBufferStride:u}=t.attributes.normal;ve(R,t.transform),Be(n,a,R,3,u),H(R)&&J(n,n),l.push([B.NORMAL,new S(n,s,3,!0)])}if(t.attributes.tangent!=null){const n=_(4*o),{typedBuffer:a,typedBufferStride:u}=t.attributes.tangent;Se(R,t.transform),Pe(n,a,R,4,u),H(R)&&J(n,n,4),l.push([B.TANGENT,new S(n,s,4,!0)])}if(t.attributes.texCoord0!=null){const n=_(2*o),{typedBuffer:a,typedBufferStride:u}=t.attributes.texCoord0;Ve(n,a,2,u),l.push([B.UV0,new S(n,s,2,!0)])}const e=t.attributes.color;if(e!=null){const n=new Uint8Array(4*o);e.elementCount===4?e instanceof Z?Q(n,e,1,255):(e instanceof Me||e instanceof Ae)&&Q(n,e,1/255,255):(n.fill(255),e instanceof Y?K(n,e.typedBuffer,1,255,4,e.typedBufferStride):(t.attributes.color instanceof Ee||t.attributes.color instanceof Oe)&&K(n,e.typedBuffer,1/255,255,4,t.attributes.color.typedBufferStride)),l.push([B.COLOR,new S(n,s,4,!0)])}return{geometry:new _e(r,l),vertexCount:o}}const R=X();function ze(t){switch(t){case"BLEND":return A.Blend;case"MASK":return A.Mask;case"OPAQUE":case null:case void 0:return A.Opaque}}function Ge(t,r){for(let o=0;o<t.model.lods.length;++o){const s=t.model.lods[o];for(const c of s.parts){const d=c.attributes.normal;if(d==null)return;const i=c.attributes.position,l=i.count,e=L(),n=L(),a=L(),u=new Float32Array(4*l),m=new Float32Array(3*l),p=de(me(),c.transform);let f=0,T=0;for(let h=0;h<l;h++){i.getVec(h,n),d.getVec(h,e),q(n,n,c.transform),pe(a,n,r.center),U(a,a,r.radius);const b=a[2],y=xe(a),g=Math.min(.45+.55*y*y,1)**ee;U(a,a,r.radius),p!==null&&q(a,a,p),he(a,a),o+1!==t.model.lods.length&&t.model.lods.length>1&&Te(a,a,e,b>-1?.2:Math.min(-4*b-3.8,1)),m[f]=a[0],m[f+1]=a[1],m[f+2]=a[2],f+=3,u[T]=g,u[T+1]=g,u[T+2]=g,u[T+3]=1,T+=4}c.attributes.normal=new Y(m),c.attributes.color=new Z(u)}}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,fetch:De,parseUrl:te},Symbol.toStringTag,{value:"Module"}));export{De as Y,Ye as o,M as s};
