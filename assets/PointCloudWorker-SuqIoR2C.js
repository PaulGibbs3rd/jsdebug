import{hX as v,b0 as g,ao as m,hY as M,hZ as d,h_ as p,h$ as y,i0 as I,i1 as w,cE as $}from"./index-CfYeSufM.js";import{u as S,c,i as x,f as F}from"./PointCloudWorkerUtil-Vntf9SMa.js";import"./PointCloudUniqueValueRenderer-uh4TfjqL.js";import"./I3SBinaryReader-BfM-k3MQ.js";class O{transform(t){const a=this._transform(t),e=[a.points.buffer,a.rgb.buffer];a.pointIdFilterMap!=null&&e.push(a.pointIdFilterMap.buffer);for(const f of a.attributes)"buffer"in f.values&&v(f.values.buffer)&&f.values.buffer!==a.rgb.buffer&&e.push(f.values.buffer);return Promise.resolve({result:a,transferList:e})}_transform(t){const a=S(t.schema,t.geometryBuffer);let e=a.length/3,f=null;const i=new Array,n=c(t.primaryAttributeData,a,e);t.primaryAttributeData!=null&&n&&i.push({attributeInfo:t.primaryAttributeData.attributeInfo,values:n});const u=c(t.modulationAttributeData,a,e);t.modulationAttributeData!=null&&u&&i.push({attributeInfo:t.modulationAttributeData.attributeInfo,values:u});let r=x(t.rendererInfo,n,u,e);if(t.filterInfo&&t.filterInfo.length>0&&t.filterAttributesData!=null){const l=t.filterAttributesData.filter(g).map(o=>{const D=c(o,a,e),h={attributeInfo:o.attributeInfo,values:D};return i.push(h),h});f=new Uint32Array(e),e=F(a,r,f,t.filterInfo,l)}for(const l of t.userAttributesData){const o=c(l,a,e);i.push({attributeInfo:l.attributeInfo,values:o})}3*e<r.length&&(r=new Uint8Array(r.buffer.slice(0,3*e))),z(a,e,t.elevationOffset);const b=_(a,e,M.fromData(t.obbData),m.fromJSON(t.inSR),m.fromJSON(t.outSR));return{obbData:t.obbData,points:b,rgb:r,attributes:i,pointIdFilterMap:f}}}function _(s,t,a,e,f){if(!d(s,e,0,s,f,0,t))throw new Error("Can't reproject");const i=p(a.center),n=I(),u=I(),r=p(a.halfSize);y(A,a.quaternion);const b=new Float32Array(3*t);for(let l=0;l<t;l++){let o=3*l;n[0]=s[o]-i[0],n[1]=s[o+1]-i[1],n[2]=s[o+2]-i[2],w(u,n,A),r[0]=Math.max(r[0],Math.abs(u[0])),r[1]=Math.max(r[1],Math.abs(u[1])),r[2]=Math.max(r[2],Math.abs(u[2])),b[o++]=n[0],b[o++]=n[1],b[o]=n[2]}return a.halfSize=r,b}function z(s,t,a){if(a!==0)for(let e=0;e<t;e++)s[3*e+2]+=a}const A=$();function U(){return new O}export{U as default};
