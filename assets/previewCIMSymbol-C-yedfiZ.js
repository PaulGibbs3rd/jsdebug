import{jI as V,eT as p,iO as m}from"./index-CfYeSufM.js";import{a as b}from"./CIMSymbolHelper-DLCfSN7J.js";import{CIMSymbolRasterizer as $}from"./CIMSymbolRasterizer-GQ2829QT.js";import{OverrideHelper as q}from"./OverrideHelper-2qszNNyl.js";import{l as D,t as S}from"./symbolUtils-DzBXc-Wp.js";import"./BidiEngine-QXap_35O.js";import"./rasterizingUtils-DzQCuzrR.js";import"./Rect-CUzevAry.js";import"./BoundingBox-hvRvsOsN.js";import"./CIMResourceManager-YgYQSCEm.js";import"./callExpressionWithFeature-B3Mz5oa9.js";import"./utils-BhrB4brX.js";import"./utils-L9BGy6Hj.js";import"./cimSymbolUtils-Bu2r_l8n.js";import"./webStyleSymbolUtils-C0OVnxdp.js";import"./devEnvironmentUtils-CnNDiFMM.js";const f=new $(null),u=m(S.size),I=m(S.maxSize),M=m(S.lineWidth),E=1;async function T(a,e,s){const i=e==null?void 0:e.size;let t=i!=null&&typeof i=="object"&&"width"in i?i.width:i,r=i!=null&&typeof i=="object"&&"height"in i?i.height:i;if(t==null||r==null)if(s==="esriGeometryPolygon")t=r=e.maxSize?Math.min(e.maxSize,u):u;else{const o=await U(a,e,s);o&&(t=o.width,r=o.height),s==="esriGeometryPolyline"&&(t=e.maxSize?Math.min(e.maxSize,M):M),t=t!=null&&isFinite(t)?Math.min(t,I):u,r=r!=null&&isFinite(r)?Math.max(Math.min(r,I),E):u}return e.style==="legend"&&s==="esriGeometryPolyline"&&(t=M),{width:t,height:r}}async function U(a,e,s){const{feature:i,fieldMap:t,viewParams:r}=e.cimOptions||e,o=await q.resolveSymbolOverrides(a.data,i,null,t,s,null,r);if(!o)return null;(a=a.clone()).data={type:"CIMSymbolReference",symbol:o},a.data.primitiveOverrides=void 0;const l=[];return b.fetchResources(o,f.resourceManager,l),b.fetchFonts(o,f.resourceManager,l),l.length>0&&await Promise.all(l),b.getEnvelope(o,null,f.resourceManager)}async function oe(a,e={}){var z,P;const{node:s,opacity:i,symbolConfig:t}=e,r=t!=null&&typeof t=="object"&&"isSquareFill"in t&&t.isSquareFill,o=e.cimOptions||e,l=o.geometryType||V((z=a==null?void 0:a.data)==null?void 0:z.symbol),n=await T(a,e,l),{feature:O,fieldMap:G}=o,L=e!=null&&e.geometry||r||l!=="esriGeometryPolygon"?"preview":"legend";let v=n;const x=n;if(e!=null&&e.geometry&&(l==="esriGeometryPolygon"||l==="esriGeometryPolyline")&&(p(n.width)<200||p(n.height)<200)){const R=n.width>n.height?m(200)*n.height/n.width:m(200);v={width:n.width>n.height?m(200):m(200)*n.width/n.height,height:R}}const g=await f.rasterizeCIMSymbolAsync(a,O,v,L,G,l,null,o.viewParams,o.allowScalingUp,(P=e==null?void 0:e.geometry)==null?void 0:P.toJSON());if(!g)return null;const{width:j,height:F}=g,c=document.createElement("canvas");c.width=j,c.height=F,c.getContext("2d").putImageData(g,0,0);const d=p(x.width),w=p(x.height),h=new Image(d,w);h.src=c.toDataURL(),h.ariaLabel=e.ariaLabel??null,h.alt=e.ariaLabel??"",i!=null&&(h.style.opacity=`${i}`);let y=h;if(e.effectView!=null){const C={shape:{type:"image",x:0,y:0,width:d,height:w,src:h.src},fill:null,stroke:null,offset:[0,0]};y=D([[C]],[d,w],{effectView:e.effectView,ariaLabel:e.ariaLabel})}return s&&y&&s.appendChild(y),y}export{oe as previewCIMSymbol};
