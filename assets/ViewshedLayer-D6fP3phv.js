import{aP as L,aW as F,aG as N,e$ as C,nf as D,bo as $,ah as G,gB as R,b as s,m as i,f0 as H,c as S,fu as P,D as J,S as B,O as U,am as W}from"./index-CfYeSufM.js";import{d as T}from"./Viewshed-KJjLXepe.js";import{c as Y}from"./Analysis-BtKnbBIC.js";import"./featureReferenceUtils-DXgECfOo.js";const _=N.ofType(T);let l=class extends Y{constructor(e){super(e),this.type="viewshed",this._extent=null}initialize(){this.addHandles(L(()=>this._computeExtent(),e=>{e.pending==null&&(this._extent=e.extent)},F))}get viewsheds(){return this._get("viewsheds")||new _}set viewsheds(e){this._set("viewsheds",C(e,this.viewsheds,_))}get spatialReference(){for(const e of this.viewsheds)if(e.observer!=null)return e.observer.spatialReference;return null}get extent(){return this._extent}get requiredPropertiesForEditing(){return this.viewsheds.items.map(({observer:e})=>e)}async waitComputeExtent(){const e=this._computeExtent();e.pending!=null&&await e.pending}_computeExtent(){const{spatialReference:e}=this;if(e==null)return{pending:null,extent:null};const r=this.viewsheds.filter(t=>t.observer!=null),c=r.map(t=>t.observer).toArray(),a=D(c,e);return a.pending!=null?{pending:a.pending,extent:null}:{pending:null,extent:a.geometries.map((t,u)=>{const g=r.at(u);return t!=null&&g!=null?this._computeViewshedExtent(this.viewsheds.at(u),t):null}).filter(t=>t!=null).reduce((t,u)=>k(t,u),null)}}_computeViewshedExtent(e,r){const{farDistance:c,heading:a,tilt:t,horizontalFieldOfView:u,verticalFieldOfView:g}=e,{spatialReference:f}=r,x=u/2,b=g/2,O=c/f.metersPerUnit,j=[$.normalize(a-x),a,$.normalize(a+x)],p=G.fromPoint(r),m=w=>{const d=j.map(o=>$.normalize(o-w));if(d[0]>d[2]||u===360)return O;const h=d.map(o=>Math.abs(o>180?360-o:o)).reduce((o,v)=>o>v?v:o);return h>90?0:O*Math.cos(R(h))};p.xmax+=m(90),p.xmin-=m(-90),p.ymax+=m(0),p.ymin-=m(180);const y=r.z;if(y!=null){let w=y,d=y;const h=t-90,o=P(h+b,-90,90),v=P(h-b,-90,90),V=f!=null&&f.isGeographic?c:O;w+=V*E(o),d+=V*E(v);const q=A(b)*V,M=E(h)*q*(1-A(x));t<90&&(w-=M),t>90&&(d-=M),p.zmax=Math.max(w,y),p.zmin=Math.min(d,y)}return p}clear(){this.viewsheds.removeAll()}};function k(e,r){return e==null?r:r==null?e:e.union(r)}function A(e){return Math.cos(R(e))}function E(e){return Math.sin(R(e))}s([i({type:["viewshed"]})],l.prototype,"type",void 0),s([i({cast:H,type:_,nonNullable:!0})],l.prototype,"viewsheds",null),s([i({readOnly:!0})],l.prototype,"spatialReference",null),s([i()],l.prototype,"_extent",void 0),s([i({readOnly:!0})],l.prototype,"extent",null),s([i({readOnly:!0})],l.prototype,"requiredPropertiesForEditing",null),l=s([S("esri.analysis.ViewshedAnalysis")],l);const z=l;let n=class extends J(B(U)){constructor(e){super(e),this.type="viewshed",this.operationalLayerType="ViewshedLayer",this.source=new z,this.opacity=1}initialize(){this.addHandles(L(()=>this.source,(e,r)=>{r!=null&&r.parent===this&&(r.parent=null),e!=null&&(e.parent=this)},F))}async load(){return this.addResolvingPromise(this.source.waitComputeExtent()),this}get spatialReference(){return this.source.spatialReference}get fullExtent(){return this.source.extent}releaseAnalysis(e){this.source===e&&(this.source=new z)}get analysis(){return this.source}set analysis(e){this.source=e}get viewsheds(){return this.source.viewsheds}set viewsheds(e){this.source.viewsheds=e}writeViewsheds(e,r,c,a){r.viewsheds=e.filter(t=>t.isValid()).map(t=>t.toJSON(a)).toJSON()}};s([i({json:{read:!1},readOnly:!0})],n.prototype,"type",void 0),s([i({type:["ViewshedLayer"]})],n.prototype,"operationalLayerType",void 0),s([i({type:z,nonNullable:!0})],n.prototype,"source",void 0),s([i({readOnly:!0})],n.prototype,"spatialReference",null),s([i({readOnly:!0})],n.prototype,"fullExtent",null),s([i({readOnly:!0,json:{read:!1,write:!1,origins:{service:{read:!1,write:!1},"portal-item":{read:!1,write:!1},"web-document":{read:!1,write:!1}}}})],n.prototype,"opacity",void 0),s([i({type:["show","hide"]})],n.prototype,"listMode",void 0),s([i({type:N.ofType(T),json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{ignoreOrigin:!0}}}}})],n.prototype,"viewsheds",null),s([W("web-scene","viewsheds")],n.prototype,"writeViewsheds",null),n=s([S("esri.layers.ViewshedLayer")],n);const Z=n;export{Z as default};
