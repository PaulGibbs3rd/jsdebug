const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/i3s-LRXEsQU1.js","assets/_commonjsHelpers-DCkdB7M8.js","assets/projectMeshVertexPositions-DhhE86nJ.js","assets/index-CfYeSufM.js","assets/vertexSpaceConversion-JNc9XxOX.js","assets/vec4-CjBq_Rau.js"])))=>i.map(i=>d[i]);
import{_ as S,gW as K,ib as Q,b4 as X,aw as ee,aA as te,bu as se,bt as re,ao as H,hx as oe,qq as ne,m6 as ie,m7 as ae,m8 as fe}from"./index-CfYeSufM.js";import{r as O}from"./I3SNode-ChRMRIyE.js";var N,g;(function(e){e[e.None=0]="None",e[e.Int16=1]="Int16",e[e.Int32=2]="Int32"})(N||(N={})),function(e){e[e.Replace=0]="Replace",e[e.Outside=1]="Outside",e[e.Inside=2]="Inside",e[e.Finished=3]="Finished"}(g||(g={}));function ce(){return v||(v=new Promise(e=>S(()=>import("./i3s-LRXEsQU1.js"),__vite__mapDeps([0,1])).then(t=>t.i).then(({default:t})=>{const s=t({locateFile:ue,onRuntimeInitialized:()=>e(s)});delete s.then})).catch(e=>{throw e})),v}function ue(e){return K(`esri/libs/i3s/${e}`)}let v;class le{constructor(t,s,n,o,c,a){this.layout=t,this.interleavedVertexData=s,this.indices=n,this.hasColors=o,this.hasModifications=c,this.positionData=a}}let he=class{constructor(t,s,n,o,c,a,u){this.componentOffsets=t,this.featureIds=s,this.anchorIds=n,this.anchors=o,this.transformedGeometry=c,this.globalTrafo=a,this.obb=u}};class Se extends Q{constructor(t){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer],project:s=>[s.positions.buffer],transformNormals:s=>[s.normals.buffer]},t,{hasInitialize:!0})}setModifications(t,s,n,o){const c={context:t,modifications:pe(s,n,o),isGeodetic:o.isGeographic};this.broadcast(c,"setModifications")}setLegacySchema(t,s){const n=JSON.stringify(s);return this.broadcast({context:t,jsonSchema:n},"setLegacySchema")}destroyContext(t){return this.broadcast(t,"destroyContext")}project(t,s){return this.invokeMethod("project",t,s)}transformNormals(t,s){return this.invokeMethod("transformNormals",t,s)}}const r=new X({deallocator:null}),x=se();function pe(e,t,s){r.clear();let n=1/0,o=1/0,c=-1/0,a=-1/0,u=!1;for(const h of t){const w=h.type==="clip"?g.Inside:h.type==="mask"?g.Outside:g.Replace,m=h.geometry;let b=p=>p;if(m.spatialReference){if(!ee(m.spatialReference,s)){te.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}b=p=>(re(p,m.spatialReference,x,s),x)}else m.hasZ||(x[2]=0,b=p=>(x[0]=p[0],x[1]=p[1],x));u=u||w===g.Outside,r.push(w),r.push(m.rings.length);for(const p of m.rings){r.push(p.length);for(const E of p){const l=b(E);r.push(l[0]),r.push(l[1]),r.push(l[2]),n=Math.min(n,l[0]),o=Math.min(o,l[1]),c=Math.max(c,l[0]),a=Math.max(a,l[1])}}}e!=null&&(u?(r.push(g.Inside),r.push(2),r.push(4),r.push(n-1e-4),r.push(o-1e-4),r.push(0),r.push(c+1e-4),r.push(o-1e-4),r.push(0),r.push(c+1e-4),r.push(a+1e-4),r.push(0),r.push(n-1e-4),r.push(a+1e-4),r.push(0),r.push(4),r.push(e[0]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[3]),r.push(0),r.push(e[0]),r.push(e[3]),r.push(0)):(r.push(g.Outside),r.push(1),r.push(4),r.push(e[0]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[1]),r.push(0),r.push(e[2]),r.push(e[3]),r.push(0),r.push(e[0]),r.push(e[3]),r.push(0))),r.push(g.Finished);const d=new Float64Array(r.length);for(let h=0;h<r.length;++h)d[h]=r.at(h);return d}async function de(e){i=await I();const t=[e.geometryBuffer];return{result:z(i,e,t),transferList:t}}async function me(e){var h;i=await I();const t=[e.geometryBuffer],{geometryBuffer:s}=e,n=s.byteLength,o=i._malloc(n),c=new Uint8Array(i.HEAPU8.buffer,o,n);c.set(new Uint8Array(s));const a=i.dracoDecompressPointCloudData(o,c.byteLength);if(i._free(o),a.error.length>0)throw new Error(`i3s.wasm: ${a.error}`);const u=((h=a.featureIds)==null?void 0:h.length)>0?a.featureIds.slice():null,d=a.positions.slice();return u&&t.push(u.buffer),t.push(d.buffer),{result:{positions:d,featureIds:u},transferList:t}}async function ye(e){await I(),J(e);const t={buffer:e.buffer};return{result:t,transferList:[t.buffer]}}async function be(e){await I(),k(e)}async function ge(e){i=await I(),i.setLegacySchema(e.context,e.jsonSchema)}async function we(e){const{localMatrix:t,origin:s,positions:n,vertexSpace:o}=e,c=H.fromJSON(e.inSpatialReference),a=H.fromJSON(e.outSpatialReference);let u;const[{projectBuffer:d},{initializeProjection:h}]=await Promise.all([S(()=>import("./index-CfYeSufM.js").then(l=>l.HA),[]),S(()=>import("./index-CfYeSufM.js").then(l=>l.HB),[])]);await h(c,a);const w=[0,0,0];if(!d(s,c,0,w,a,0))throw new Error("Failed to project");if(o.type==="georeferenced"&&o.origin==null){if(u=new Float64Array(n.length),!d(n,c,0,u,a,0,u.length/3))throw new Error("Failed to project")}else{const l=o.type==="georeferenced"?oe.fromJSON(o):ne.fromJSON(o),{projectMeshVertexPositions:y}=await S(async()=>{const{projectMeshVertexPositions:A}=await import("./projectMeshVertexPositions-DhhE86nJ.js");return{projectMeshVertexPositions:A}},__vite__mapDeps([2,3,4,5])),_=y({vertexAttributes:{position:n},transform:t?{localMatrix:t}:void 0,vertexSpace:l,spatialReference:c},a);if(!_)throw new Error("Failed to project");u=_}const m=u.length,[b,p,E]=w;for(let l=0;l<m;l+=3)u[l]-=b,u[l+1]-=p,u[l+2]-=E;return{result:{projected:u,original:n,projectedOrigin:w},transferList:[u.buffer,n.buffer]}}async function _e({normalMatrix:e,normals:t}){const s=new Float32Array(t.length);return ie(s,t,e),ae(e)&&fe(s,s),{result:{transformed:s,original:t},transferList:[s.buffer,t.buffer]}}function Ee(e){Y(e)}let Ae,i;function k(e){if(!i)return;const t=e.modifications,s=i._malloc(8*t.length),n=new Float64Array(i.HEAPU8.buffer,s,t.length);for(let o=0;o<t.length;++o)n[o]=t[o];i.setModifications(e.context,s,t.length,e.isGeodetic),i._free(s)}function z(e,t,s){const{context:n,globalTrafo:o,mbs:c,obbData:a,elevationOffset:u,geometryBuffer:d,geometryDescriptor:h,indexToVertexProjector:w,vertexToRenderProjector:m}=t,b=e._malloc(d.byteLength),p=33,E=e._malloc(p*Float64Array.BYTES_PER_ELEMENT),l=new Uint8Array(e.HEAPU8.buffer,b,d.byteLength);l.set(new Uint8Array(d));const y=new Float64Array(e.HEAPU8.buffer,E,p);P(y,[NaN,NaN,NaN]);let _=y.byteOffset+3*y.BYTES_PER_ELEMENT,A=new Float64Array(y.buffer,_);P(A,o),_+=16*y.BYTES_PER_ELEMENT,A=new Float64Array(y.buffer,_),P(A,c),_+=4*y.BYTES_PER_ELEMENT,a&&(A=new Float64Array(y.buffer,_),P(A,a));const F=h,G={isDraco:!1,isLegacy:!1,color:t.layouts.some(L=>L.some(M=>M.name==="color")),normal:t.needNormals&&t.layouts.some(L=>L.some(M=>M.name==="normalCompressed")),uv0:t.layouts.some(L=>L.some(M=>M.name==="uv0")),uvRegion:t.layouts.some(L=>L.some(M=>M.name==="uvRegion")),featureIndex:F.featureIndex},f=e.process(n,!!t.obbData,b,l.byteLength,F,G,E,u,w,m,t.normalReferenceFrame);if(e._free(E),e._free(b),f.error.length>0)throw new Error(`i3s.wasm: ${f.error}`);if(f.discarded)return null;const R=f.componentOffsets.length>0?f.componentOffsets.slice():null,j=f.featureIds.length>0?f.featureIds.slice():null,W=f.anchorIds.length>0?Array.from(f.anchorIds):null,q=f.anchors.length>0?Array.from(f.anchors):null,T=f.interleavedVertedData.slice().buffer,$=f.indicesType===N.Int16?new Uint16Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/2).slice():new Uint32Array(f.indices.buffer,f.indices.byteOffset,f.indices.byteLength/4).slice(),U=f.positions.slice(),{buffer:B,byteOffset:D,byteLength:C}=f.positionIndices,V=f.positionIndicesType===N.Int16?new Uint16Array(B,D,C/2).slice():new Uint32Array(B,D,C/4).slice(),Z=new le(t.layouts[0],T,$,f.hasColors,f.hasModifications,{data:U,indices:V});return j&&s.push(j.buffer),R&&s.push(R.buffer),s.push(T),s.push($.buffer),s.push(U.buffer),s.push(V.buffer),new he(R,j,W,q,Z,o,f.obb)}function Le(e){return e===0?O.Unmodified:e===1?O.PotentiallyModified:e===2?O.Culled:O.Unknown}function J(e){if(!i)return;const{context:t,buffer:s}=e,n=i._malloc(s.byteLength),o=s.byteLength/Float64Array.BYTES_PER_ELEMENT,c=new Float64Array(i.HEAPU8.buffer,n,o),a=new Float64Array(s);c.set(a),i.filterOBBs(t,n,o),a.set(c),i._free(n)}function Y(e){i&&i.destroy(e)===0&&(i=null)}function P(e,t){for(let s=0;s<t.length;++s)e[s]=t[s]}async function Me(){i||await I()}async function I(){return i||(i=await(Ae??(Ae=ce()))),i}const xe={transform:(e,t)=>i&&z(i,e,t),destroy:Y},Ne=Object.freeze(Object.defineProperty({__proto__:null,destroyContext:Ee,dracoDecompressPointCloudData:me,filterObbsForModifications:ye,filterObbsForModificationsSync:J,initialize:Me,interpretObbModificationResults:Le,process:de,project:we,setLegacySchema:ge,setModifications:be,setModificationsSync:k,test:xe,transformNormals:_e},Symbol.toStringTag,{value:"Module"}));export{Le as L,Me as P,J as S,Se as a,Ne as b,pe as f,k as j};
