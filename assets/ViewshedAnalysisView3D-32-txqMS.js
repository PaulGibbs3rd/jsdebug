import{gB as y,aD as ie,oX as zt,g7 as ne,iw as G,rR as Q,cy as S,g0 as Zt,g1 as Ht,f_ as Lt,fo as ue,bu as p,by as k,iv as we,Eu as ei,Ev as ti,EE as ye,g4 as fe,gv as C,fu as Se,g6 as X,g5 as U,lF as Te,u as x,bE as It,wb as ce,EF as Oe,u2 as Ut,rT as $e,bz as K,wc as ke,gc as ii,aP as M,P as E,mi as je,ge as si,uc as Ne,ct as q,rQ as We,wh as st,gs as _e,EG as j,w9 as ai,xq as me,gw as ri,EH as oi,r9 as ni,b as l,m as d,g as Ve,aW as de,b0 as li,fe as De,r4 as hi,xN as ci,bo as at,fd as di,lV as ui,N as pi,bq as vi,c as se,wO as Ke,e_ as Ye,aQ as kt,b$ as Be,wS as wi,gx as fi,aU as mi,yx as gi,eD as _i,fD as Vi,fB as bi,cv as jt,gi as Je,wR as Mi,jM as yi,fn as Si,cr as Oi,ur as Di,ut as Ti,r8 as rt,c5 as $i,EI as Ei,EJ as Ai,EK as ot,EL as nt,CI as lt,G as Ri,CN as xi,EM as Ci,EN as Pi,EO as Fi,qz as Nt,EP as Wt,CV as Ge,mg as ht,t_ as zi,EQ as Hi,ER as Li,ES as Ii,ET as Ui,EU as ki,EV as ji,Du as ct,Em as Ae,Dw as Re,CX as Ni,CY as dt,EW as ut,EX as Wi,EY as Bi,CZ as Gi,C_ as qi,_ as Qi,D0 as Xi,E2 as Ki,D5 as Yi,EZ as Ji,aG as Zi,E_ as xe,E$ as pt,lp as es,p7 as ts,xu as is,gt as ss,gp as vt,fM as as,fN as rs,aA as os,aw as ns,f2 as ls,br as hs}from"./index-CzvLtnX1.js";import{d as cs,m as ds}from"./featureReferenceUtils-Bk8cvZgN.js";import{s as us}from"./AnalysisView3D-BKZHpM3V.js";import{a as ps,d as ae,b as vs}from"./LineVisualElement-Dmig6oYe.js";import{d as ws}from"./Viewshed-DAXA_m8H.js";import{O as fs,w as ms,a as oe,e as Ee,f as gs}from"./ShadedColorMaterial.glsl-ftyccgmu.js";import{C as wt,A as _s}from"./dragEventPipeline3D-BgOPl69K.js";import{B as Bt,A as ee,o as Gt,a as Vs,u as bs,j as Ms}from"./MoveManipulation-B_C3dVDr.js";import{p as Me,M as ys,h as Ce,f as Ss}from"./InteractiveToolBase-CXcuwHxr.js";import{s as Ze}from"./sliceToolConfig-keiWzNcS.js";import{A as qt}from"./ColorMaterial.glsl-C-PiVLm-.js";import{E as Os}from"./EditGeometryOperations-B_ujSqy0.js";import{G as Ds}from"./ExtendedLineVisualElement-Ds1RnamP.js";import{c as Ts,S as $s}from"./LaserlinePath.glsl-7piOlJpM.js";import{o as Es,a as As,v as Rs,l as xs}from"./analysisViewUtils-LLUt6l8J.js";import{p as ft}from"./keybindings-DIxDEOyk.js";import{t as Cs}from"./ToolIntersector-DI2Et5aL.js";import{h as Ps}from"./lineStippleUtils-CCavR4OV.js";import"./line-sE7VsM4I.js";import"./TriangleMaterial-DGLj9Hvg.js";import"./geometry2dUtils-C5OK12a_.js";import"./EngineVisualElement-D9oh89bd.js";const mt=2,Fs=4,Qt=y(2),zs=1.5;let Hs=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Fs,this.fovFocusedArcWidth=mt*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=mt/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(t){return t?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(t){return this.scaleOrientArrowTipLength*(t?this.scaleOrientArrowTipFocusMultiplier:1)}};const z=new Hs;class Ls{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ie([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ie.toUnitRGBA(new ie([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:ne.Occlude,cullFace:zt.Back,writeDepth:!1}}}const J=new Ls;function et({tiltedUpVector:s,rightVector:t,observerRenderSpace:e},i){const a=fs(s,t,e,i);return a[12]=0,a[13]=0,a[14]=0,a}function qe(s,t,e,i){const a=p(),r=Zt(e.plane),o=Is(t,r);let h;if(Math.abs(o)>z.viewAngleThreshold)h=s.next(wt(t,e.plane));else{const c=Ht(i.targetRenderSpace,e.basis1,Lt()),u=ue(Xt,e.basis1),n=ue(Us,e.basis2);h=s.next(wt(t,c)).next(v=>{const w=D=>{const O=fe(C(gt,D,e.origin),n),A=Math.acos(Se(O/i.farDistanceRenderSpace,-1,1)),P=Math.sin(A)*i.farDistanceRenderSpace;return X(p(),e.origin,X(p(),U(gt,u,P),U(ks,n,O)))},f=w(v.renderStart),m=w(v.renderEnd);return{...v,renderStart:f,renderEnd:m}})}return h.next(c=>{c.action==="start"&&k(a,c.renderStart);const u=we(ms(a,c.renderEnd,e.origin,r));return{...c,deltaAngle:u}})}function Is(s,t){const e=Xt;s.renderCoordsHelper.toRenderCoords(s.camera.position,e);const i=ei(s,e,s.camera.heading,s.camera.tilt,ti()).direction;return we(ye(i,t))-90}function te(s,t,e,i){return Q(_t,e,i),G(s,t,_t)}const Xt=p(),Us=p(),gt=p(),ks=p(),_t=S();let js=class extends Bt{constructor(t){super(),this._handles=new Te,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=x(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(t,e){const i=Object.values(this._manipulators);return It(i.map(({manipulator:a,side:r})=>Me(a,(o,h,c,u,n)=>{const v=Qs(r,e),w=h.next(m=>({...m,manipulatorType:ee.SCALE,side:r})),f=qe(w,this._view,v,e);t(o,f,c)})))}updateManipulatorsTransform(t){t.arcCentersPoints(Vt),this._forEachManipulatorInfo(e=>this._updateArcManipulatorTransform(e,t,Vt[e.side]))}updateManipulatorVisuals(t){this._forEachManipulatorInfo(e=>this._updateArcManipulatorVisuals(e,t))}_updateArcManipulatorVisuals({manipulator:t,side:e},i){const a=[];if(i!=null){const[r,o]=Ns(e,i,this._unfocusedArcMaterial);a.push(new oe(r,ce.Unfocused),new oe(r.instantiate({material:this._focusedArcMaterial}),ce.Focused)),t.collisionType={type:"line",paths:[o]}}t.renderObjects=a,t.radius=z.collisionRadius}_updateArcManipulatorTransform({manipulator:t,side:e},i,a){const r=i.horizontalFieldOfView,o=y(i.verticalFieldOfView/2),h=y(r/2),c=ge(e);t.renderLocation=a;const u=S(),n=D=>{je(u,D,u)};n(Oe(le,y(-90))),c||n(Ut(le,o));const v=i.farDistanceRenderSpace;let w,f;n($e(le,K(Kt,v,v,v))),n(ke(le,Gs(e))),n(et(i,le)),c?(w=h,f=i.tiltedUpVector):(f=i.rightVector,w=o),w*=e==="right"||e==="bottom"?-1:1;const m=Q(le,w,f);m!=null&&n(m),t.modelTransform=u}_createManipulators(){const t=this._createArcManipulator("left"),e=this._createArcManipulator("right"),i=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:t,right:e,top:i,bottom:a},[[a.manipulator,i.manipulator],[t.manipulator,e.manipulator]].forEach(([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}})}_createArcManipulator(t){const e=new Ee({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),i={manipulator:e,side:t};return this._updateArcManipulatorVisuals(i),this._handles.add(e.events.on("focus-changed",a=>{const r=e.metadata?.pairedManipulator;r!=null&&(r.hovering!==e.hovering&&(r.hovering=e.hovering),r.grabbing!==e.grabbing&&(r.grabbing=e.grabbing))})),i}_createArcMaterial(t){const e=z.getFovArcWidth(t),i=new ii({renderOccluded:ne.OccludeAndTransparent,isDecoration:!0,width:e});return this._handles.add(M(()=>ie.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>i.setParameters({color:a}),E)),i}forEachManipulator(t){Object.values(this._manipulators).forEach(({manipulator:e})=>t(e,ee.SCALE))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach(e=>t(e))}get test(){return{manipulators:this._manipulators}}};function Ns(s,t,e){const{horizontalFieldOfView:i,verticalFieldOfView:a}=t,r=ge(s),o=y(Se((r?a:i)/2,0,15)),h=Ws(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[si(e,h),h]}function Ws(s,t,e,i=10){Ne(i>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-s;if(a<=0||e<=0)return[q(0,0,.01),q(0,0,-.01)];const r=[],o=a/i;for(let h=0;h<i;h++){let c=s+h*o;h===i-1&&(c=t);const u=Math.cos(c)*e,n=Math.sin(c)*e,v=q(u-e,0,n);r.push(v)}return r}function Bs(s){switch(s){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Gs(s){return Bs(s)*Xs}function ge(s){return s==="left"||s==="right"}function qs(s){return s==="left"?"right":s==="right"?"left":s==="top"?"bottom":"top"}function Qs(s,{observerRenderSpace:t,targetRenderSpace:e,tiltedUpVector:i,rightVector:a,farDistanceRenderSpace:r}){const o=C(Kt,e,t),h=ge(s)?a:i,c=U(Ks,h,r);return We(t,o,c)}const Xs=Math.PI/2,le=S(),Kt=p(),Ks=p(),Vt={top:p(),bottom:p(),left:p(),right:p()};let Pe=class extends Ee{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:z.collisionRadius}),this._handles=new Te,this._setupManipulatorVisual(e)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t){const e=this._createMaterial(),i=1,a=[q(0,0,0),q(0,0,i)],r=st(e,a,t,16,!1),o=st(e,a,t*Ze,16,!1),h=bt(!1,e,t),c=bt(!0,e,t),u=S();_e(u,a[a.length-1]),j(u,u,Ut(Mt,Math.PI/2)),j(u,u,Oe(Mt,Math.PI/2)),h.transformation=u,c.transformation=u,this.renderObjects=[new oe(r,ce.Unfocused),new oe(o,ce.Focused),new oe(h,ce.Unfocused),new oe(c,ce.Focused)];const n=q(0,z.getScaleOrientArrowTipLength(!0),0),v=G(n,n,u),w=[...a,v];this.collisionType={type:"line",paths:[w]}}_createMaterial(){const t=new qt({cullFace:zt.Back,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});return this._handles.add(M(()=>ie.toUnitRGBA(this.view.effectiveTheme.accentColor),e=>t.setParameters({color:e}),E)),t}};function bt(s,t,e){const i=z.getScaleOrientArrowTipLength(s);let a=2*e;s&&(a*=Ze);const r=i/2;return ai(t,i,r,r,a,0)}const Mt=S();let Ys=class extends Bt{constructor(t){super(),this._handles=new Te,this._tool=t.tool,this._view=t.view;const e=z.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,e),this._manipulatorTilt=new Pe(this._view,e),this._manipulatorDistance=new Pe(this._view,e),this.forEachManipulator(i=>this._tool.manipulators.add(i))}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return Me(this._manipulatorHeading,(i,a,r,o,h)=>{const c=this._view,{tiltParallelToSurface:u,farDistanceRenderSpace:n,upVector:v,observerRenderSpace:w,targetRenderSpace:f,rightVector:m}=e,D=Math.sin(y(u))*n,O=X(be,w,U(Fe,v,D)),A=C(Fe,f,O),P=U(Js,m,me(A)),R=We(O,A,P),H=qe(a,c,R,e).next(L=>({...L,manipulatorType:ee.ROTATE}));t(i,H,r)})}createTiltDragPipeline(t,e){return Me(this._manipulatorTilt,(i,a,r,o,h)=>{const{observerRenderSpace:c,farDistanceRenderSpace:u,upVector:n,targetDirection:v}=e,w=fe(v,n),f=ri(be,v,n,-w);U(f,ue(f,f),u);const m=U(Fe,n,u),D=We(c,f,m),O=qe(a,this._view,D,e).next(A=>({...A,manipulatorType:ee.ROTATE}));t(i,O,r)})}createDistanceDragPipeline(t,e){return Me(this._manipulatorDistance,(i,a,r,o,h)=>{const c=oi(e.observerRenderSpace,e.targetDirection),u=a.next(ys(this._view,i.location)).next(_s(this._view,c)).next(n=>({...n,manipulatorType:ee.SCALE}));t(i,u,r)})}updateManipulators(t){const{targetRenderSpace:e}=t;this._manipulatorHeading.renderLocation=e,this._manipulatorTilt.renderLocation=e,this._manipulatorDistance.renderLocation=e;const i=S(),a=n=>{je(i,n,i)},r=z.scaleOrientSize*(Gt/Vs);a($e(pe,K(be,r,r,r))),a(et(t,pe));const o=z.scaleOrientHandleRadius*Ze*r,h=U(be,t.targetDirection,o);a(_e(pe,h));const c=ke(pe,-ze);j(c,c,Oe(yt,-ze)),this._manipulatorHeading.modelTransform=j(S(),i,c);const u=Oe(pe,ze);j(u,u,ke(yt,Math.PI)),this._manipulatorTilt.modelTransform=je(S(),i,u),this._manipulatorDistance.modelTransform=i}forEachManipulator(t){t(this._manipulatorHeading,ee.ROTATE),t(this._manipulatorTilt,ee.ROTATE),t(this._manipulatorDistance,ee.SCALE)}};const pe=S(),yt=S(),be=p(),Fe=p(),Js=p(),ze=Math.PI/2;let Yt=class extends Ee{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:z.observerSize,interactive:!1}),this._handles=new Te;const i=gs(this._color);this.renderObjects=[new oe(ni(i,z.observerSize,32,32))],e.manipulators.add(this),this._handles.add([M(()=>this._color,a=>{i.setParameters({color:a})},E)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ie.toUnitRGBA(this.view.effectiveTheme.accentColor)}};l([d()],Yt.prototype,"_color",null);const St=Symbol("dragHandles"),Ot=Symbol("hideManipulators"),Dt=Symbol("hideFoVManipulators"),Tt=Symbol("hideObserverManipulator");let I=class extends Ve{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new js({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new Ys({view:this.view,tool:this.parentTool}),this._observerManipulator=new Yt(this.view,this.parentTool),this.addHandles([M(()=>this.viewshedComputedData?.observerRenderSpace,e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},de),M(()=>this.viewshedComputedData?.heading,e=>{e&&(this._moveManipulation.angle=y(90-e))},E),M(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}},({viewshedComputedData:e,observer:i},a)=>{this._grabbing&&i!==a?.observer||(this.removeHandles(St),e?.isValid()&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(li),St))},E),M(()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},E),M(()=>{const e=this.viewshedComputedData;return e?.isValid()?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},E),M(()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.isValid()??!1),i=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||i)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:i})=>{this._moveManipulation.available=i,this._scaleOrientManipulation.available=i,this._observerManipulator.available=i,this._fieldOfViewManipulation.available=e},E),M(()=>{const e=this.viewshedComputedData;if(!e?.isValid())return null;const{observer:i,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:i,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},E)]);const t=e=>{const i=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||a||(this._forceHoveringTask=di(async r=>{await(this._forceHoveringTestPromise??ui(z.hoverTimeoutMilliseconds,r)),pi(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",a=>{this._grabbing=a.action==="start",a.action==="end"&&i.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach(({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)}),this._setInteractive(r=>r.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",a=>{a.action==="start"&&i.tool?.updateInteractionVisualsVisibility()})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=De(this._forceHoveringTask),this._moveManipulation=x(this._moveManipulation),this._fieldOfViewManipulation=x(this._fieldOfViewManipulation),this._scaleOrientManipulation=x(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=x(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){const{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){const e=typeof t=="boolean";this._forEachManipulation(i=>i.interactive=e?t:t(i))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(i=>{e=e||i===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new bs({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Gt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},i=t.observer;if(i==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,o,h,c,u)=>{c=c.next(Ce(this,["observer"]));const n=hi(i,a);if(n==null)return{steps:h,cancel:c};const v=Os.fromGeometry(n,ci(this.view.viewingMode));return{steps:h.next(Ss({operations:v})).next(w=>(this.observer=v.data.geometry,w)),cancel:c}},e,a,void 0)}_buildFOVDragPipeline(t){let e=0,i=0;return this._fieldOfViewManipulation.createDragPipeline((a,r,o)=>{if(t==null)return{steps:r,cancel:o};const h=t.viewshed;let c=null;return o=o.next(Ce(h,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(u=>{u.action==="start"&&(c=null,e=t.horizontalFieldOfView,i=t.verticalFieldOfView);const n=u.deltaAngle;if(c==null&&n!==0){const f=u.side==="bottom"||u.side==="left"?n>0:n<0;c=ge(u.side)?e===0&&f||e===360&&!f:i===0&&f}const v=c?qs(u.side):u.side;let w=0;switch(v){case"left":w=e/2-n;break;case"right":w=e/2+n;break;case"top":w=i+2*n;break;case"bottom":w=i-2*n}return ge(v)?(w=at.normalize(w),w=w>270?0:w>180?180:w,h.horizontalFieldOfView=2*w):h.verticalFieldOfView=w,u}),cancel:o}},t)}_buildScaleOrientDragPipeline(t){let e=0,i=0;const a=(r,o)=>(h,c,u)=>{if(t==null)return{steps:c,cancel:u};const n=t.viewshed;return u=u.next(Ce(n,[r])),{steps:c=c.next(o(n,t)),cancel:u}};return It([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",(r,o)=>h=>(h.action==="start"&&(i=t.heading),r.heading=at.normalize(i+h.deltaAngle),h)),t),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",(r,o)=>h=>{h.action==="start"&&(e=t.tilt);let c=e+h.deltaAngle;return c<-90?c=180:c>270&&(c=0),r.tilt=ea.clamp(c),h}),t),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",(r,o)=>h=>{const c=C(Zs,h.renderEnd,o.observerRenderSpace),u=me(c)*o.metersPerUnit,n=fe(c,o.targetDirection)<0?z.scaleOrientMinDistance:u;return r.farDistance=n,h}),t)])}_updateManipulatorVisibility(){const t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),i=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=h=>{r.push(h.disableDisplay())};t||!a&&e?this.removeHandles(Ot):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,Ot),r=[]),t||!a&&e||a&&i?this.removeHandles(Dt):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,Dt)),t||!a?this.removeHandles(Tt):this.addHandles(this._observerManipulator.disableDisplay(),Tt)}_resetHoveringTask(){this._forceHoveringTask=De(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};l([d({constructOnly:!0})],I.prototype,"analysis",void 0),l([d({constructOnly:!0})],I.prototype,"analysisViewData",void 0),l([d({constructOnly:!0})],I.prototype,"parentTool",void 0),l([d({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),l([d()],I.prototype,"viewshed",null),l([d()],I.prototype,"_grabbing",void 0),l([d()],I.prototype,"grabbing",null),l([d()],I.prototype,"viewshedComputedData",void 0),l([d()],I.prototype,"observer",null),I=l([se("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],I);const Zs=p(),ea=new vi(0,180),He=Symbol("interactionVisuals");let T=class extends Es{constructor(t){super(t),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Ms({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Cs(this.view.state.viewingMode),this._createInteractionVisuals();const t=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Ke(()=>t,({viewshedComputedData:e})=>{const i=new I({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:e});return{subTool:i,remove:()=>{this.selectedViewshed===e.viewshed&&(this.selectedViewshed=null),i.destroy()}}}),this.addHandles([M(()=>t?.some(e=>e.viewshedComputedData.isValid()),e=>{e&&this.finishToolCreation()},de),M(()=>this._stagedViewshed,e=>{const i=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=e!=null&&i!=null?this._findSubTool(e)?.viewshedComputedData:null},de),M(()=>this.firstGrabbedManipulator,e=>{if(e!=null){const i=this._findSubTool(e)?.viewshed;this.selectedViewshed=i,this._selectManipulator(e)}else this._selectedSubTool?.onManipulatorSelectionChanged()},kt),M(()=>this.view.activeTool,e=>{e!==this&&e!=null&&(this.selectedViewshed=null)}),Ye(()=>{const e=this.selectedViewshedComputedData;return e==null?null:{subTool:this._selectedSubTool,observer:e.observerRenderSpace,target:e.targetRenderSpace}},e=>{const{subTool:i,observer:a,target:r}=e;i?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(a,!0):i?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(r,!1)},E),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,e=>{const i=this._selectedManipulator,a=this._selectedSubTool;e==null?this._selectManipulator(null):i!=null&&a.hasManipulator(i)||this._selectManipulator(a.discManipulator)},E)])}destroy(){this.subToolHandles=x(this.subToolHandles),this.removeHandles(He)}onDeactivate(){this.removeStaged(),this._creationState=!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(t){const e=this._selectedManipulator;e!==t&&(this._selectedManipulator=t,e!=null&&(e.selected=!1),t!=null&&(t.selected=!0),this._findSubTool(e)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(t){this.analysisViewData.selectedViewshed=t}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:t})=>t.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}createViewsheds(){this.selectedViewshed=null,this._creationState="placing-observer"}onManipulatorSelectionChanged(){this.subToolHandles.forEach(t=>t.subTool.onManipulatorSelectionChanged())}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":ft.cancel===t.key?this._cancelKeyHandler(t):ft.delete.includes(t.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickPlacementHandler(t)}_clickPlacementHandler(t){if(!this.creating||this.hasFocusedManipulators)return;const e=this._intersectScreen(t,Et);if(e!=null){if(this._creationState==="placing-observer"){e.mapPoint.z=(e.mapPoint.z??0)+zs;const i=new ws({observer:e.mapPoint.clone(),feature:e.feature});this.analysis.viewsheds.add(i),this._stagedViewshed=i,this._creationState="placing-target",this._updateStagedViewshed(e.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(e.scenePoint);const i=this._stagedViewshed;this._creationState="placing-observer",this._stagedViewshed=null,this.selectedViewshed=i}t.stopPropagation()}}_doubleClickHandler(t){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(!this.creating)return;const e=this._intersectScreen(t,Et);e!=null&&(this._updateInteractionVisualsLocation(e.scenePoint,!1),this._updateStagedViewshed(e.scenePoint))}_cancelKeyHandler(t){if(this.creating){if(this.removeStaged())return this._creationState="placing-observer",this.selectedViewshed=null,void t.stopPropagation();this._creationState=!1}else if(!this.grabbing)return this.selectedViewshed=null,void t.stopPropagation()}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_updateStagedViewshed(t){const e=this._stagedViewshed,i=this._stagedViewshedComputedData;if(e==null||i==null)return;const{heading:a,tilt:r,farDistance:o}=ta(this.view,i,t);e.farDistance=o,e.tilt=r,e.heading=a}removeStaged(){return this._stagedViewshed!=null&&(this.analysis.viewsheds.remove(this._stagedViewshed),this._stagedViewshed=null,!0)}_intersectScreen(t,e){const i=wi(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(i,this._intersector);const a=this._intersector.results.min,r=e.scenePoint;if(!a.getIntersectionPoint(r))return null;const o=e.mapPoint;return o.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(r,o),o==null?null:(e.feature=fi(a,this.view),e)}_createInteractionVisuals(){this.removeHandles(He);const t=this._settings.visualElements,e=new Ts({view:this.view,attached:!1,style:{glowWidth:t.heightPlane.glowWidth,innerWidth:t.heightPlane.innerWidth},isDecoration:!0}),i=new Ds({view:this.view,extensionType:t.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:e,verticalLine:i},this.addHandles([M(()=>t.zVerticalLine,a=>a.apply(i),de),M(()=>t.heightPlane,a=>a.apply(e),de),mi(()=>{e.destroy(),i.destroy(),this._interactionVisualElements=null})],He)}updateInteractionVisualsVisibility(t=!1){const e=this.creating,i=this.analysisViewData.visible,a=this._selectedSubTool,r=this.selectedViewshedComputedData,o=(w,f)=>{const m=this._interactionVisualElements;m!=null&&(m.verticalLine.attached=f,m.laserline.attached=w)};if(e)return void o(i,!1);if(a==null||r==null)return void o(!1,!1);const h=a.moveInteractionState,c=t?h.grabbing:h.dragging,u=a.scaleOrientInteractionState,n=t?u.grabbing:u.dragging,v=i&&(c||n);if(o(v,c),v){const w=c?r.observerRenderSpace:r.targetRenderSpace;this._updateInteractionVisualsLocation(w,c)}}_updateInteractionVisualsLocation(t,e){const i=this._interactionVisualElements;if(i==null)return;const{laserline:a,verticalLine:r}=i;a.heightManifoldTarget=t,a.intersectsWorldUpAtLocation=e?t:null,t!=null&&r.setStartEndFromWorldDownAtLocation(t)}_findSubTool(t){if(t==null)return null;const e=t instanceof Ee?i=>i.subTool.hasManipulator(t):i=>i.subTool.viewshed===t;return this.subToolHandles?.find(e)?.subTool}get test(){}};function ta(s,t,e){const i=t.observerRenderSpace,a=C(ia,e,i),r=me(a)*t.metersPerUnit,o=s.renderCoordsHelper.basisMatrixAtPosition(i,ra),h=K(sa,o[8],o[9],o[10]),c=Ht(i,h,oa),u=gi(c,e,aa),n=C(u,u,i),v=(me(n)<1e-4?90:we(ye(a,n)))*(fe(h,a)<0?-1:1)+90,w=K($t,o[4],o[5],o[6]),f=we(ye(w,n)),m=K($t,o[0],o[1],o[2]);return{heading:fe(n,m)<0?360-f:f,tilt:v,farDistance:r}}l([d({constructOnly:!0})],T.prototype,"view",void 0),l([d()],T.prototype,"analysisViewData",void 0),l([d()],T.prototype,"removeIncompleteOnCancel",void 0),l([d()],T.prototype,"automaticManipulatorSelection",void 0),l([d({constructOnly:!0})],T.prototype,"analysis",void 0),l([d()],T.prototype,"subToolHandles",void 0),l([d()],T.prototype,"_stagedViewshed",void 0),l([d()],T.prototype,"_stagedViewshedComputedData",void 0),l([d()],T.prototype,"_creationState",void 0),l([d({readOnly:!0})],T.prototype,"cursor",null),l([d()],T.prototype,"_selectedManipulator",void 0),l([d()],T.prototype,"_selectedSubTool",null),l([d()],T.prototype,"selectedViewshed",null),l([d()],T.prototype,"selectedViewshedComputedData",null),l([d()],T.prototype,"stagedViewshed",null),l([d()],T.prototype,"grabbing",null),l([d()],T.prototype,"creating",null),l([d()],T.prototype,"isPlacingTarget",null),T=l([se("esri.views.3d.analysis.Viewshed.ViewshedTool")],T);const ia=p(),sa=p(),aa=p(),$t=p(),ra=S(),oa=Lt(),Et={mapPoint:new Be,scenePoint:p(),feature:null},Qe=T;class na extends ps{constructor(t){super(t),this._material=null,this._viewshedComputedData=null,this._material=new qt({...J.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(t)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(t){this._viewshedComputedData=t,this.updateTransform()}updateTransform(){const t=this._viewshedComputedData;if(t==null)return;const e=S(),i=t.farDistanceRenderSpace;$e(e,q(i,i,i)),et(t,ve),j(e,ve,e),_e(ve,this._viewshedComputedData.observerRenderSpace),j(e,ve,e),this.transform=e}createExternalResources(){}destroyExternalResources(){}forEachExternalMaterial(t){this._material!=null&&t(this._material)}createGeometries(t){const{_material:e,viewshedComputedData:i}=this;i==null||e==null||!i.isValid()||la(e,i).forEach(a=>t.addGeometry(a))}}function la(s,t){const{horizontalFieldOfView:e,verticalFieldOfView:i}=t,a=K(ha,0,0,1),r=K(Rt,0,1,0),o=K(xt,1,0,0);te(a,a,y(i/2),r),te(a,a,y(e/2),o);const h=b=>Math.ceil(Math.abs(b)/Qt)+1,c=y(e),u=k(ca,o),n=h(c),v=At(-c/(n-1)),w=Q(ve,v,u),f=y(-i),m=h(f),D=At(f/(m-1)),O=k(Rt,r),A=Q(Ct,y(e)/2,o);G(O,O,A);const P=Ct,R=[],H=k(xt,a);for(let b=0;b<n;b++){Q(P,D,O);for(let g=0;g<m;g++){const _=3*(g*n+b);R[_]=H[0],R[_+1]=H[1],R[_+2]=H[2],G(H,H,P)}G(O,O,w),G(a,a,w),k(H,a)}const L=n*m;R[3*L]=0,R[3*L+1]=0,R[3*L+2]=0;const N=[];for(let b=0;b<n-1;b++)for(let g=0;g<m-1;g++){const _=6*(g*(n-1)+b);N[_]=g*n+b,N[_+1]=(g+1)*n+b,N[_+2]=g*n+b+1,N[_+3]=g*n+b+1,N[_+4]=(g+1)*n+b,N[_+5]=(g+1)*n+b+1}const Y=[N];if(e!==360&&i!==0){const b=[],g=[];for(let _=0;_<m-1;_++){const $=3*_;b[$]=L,b[$+1]=(_+1)*n,b[$+2]=_*n,g[$]=L,g[$+1]=_*n+n-1,g[$+2]=(_+1)*n+n-1}Y.push(b,g)}if(i!==180&&e!==0){const b=[],g=[];for(let _=0;_<n-1;_++){const $=3*_;b[$]=L,b[$+1]=_,b[$+2]=_+1,g[$]=L,g[$+1]=_+(m-1)*n+1,g[$+2]=_+(m-1)*n}Y.push(b,g)}return Y.map(b=>{const g=[[_i.POSITION,new Vi(R,b,3,!0)]];return new bi(s,g)})}function At(s){return isNaN(s)?1:s}const ha=p(),Rt=p(),xt=p(),ca=p(),ve=S(),Ct=S();let W=class extends Ve{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:p(),topRight:p(),bottomLeft:p(),bottomRight:p()},this._arcCenterPoints={top:p(),bottom:p(),left:p(),right:p()},this._parallelCenters={top:p(),bottom:p()}}initialize(){const t={view:this.view,isDecoration:!0},e={...t,color:this._color,renderOccluded:ne.OccludeAndTransparent},i={...e,stipplePattern:Ps(2)};this._observerVisualElement=new $s({...t,...J.observerPointConfiguration}),this._shapeVisualElement=new na(t),this._frameLinesVisualElement=new ae(e),this._leftArcVisualElement=new ae(e),this._rightArcVisualElement=new ae(e),this._topArcVisualElement=new ae(e),this._bottomArcVisualElement=new ae(e),this._centralLongitude=new ae(i),this._centralLatitude=new ae(i),this.addHandles([M(()=>{const a=this.viewshedComputedData;if(!a?.isValid())return null;const r=this._viewshedCorners,o=this._arcCenterPoints,h=this._parallelCenters;return a.cornerPoints(r),a.arcCentersPoints(o),a.parallelCenterPoints(h),{viewshedComputedData:a,corners:r,arcCenters:o,parallelCenters:h,interactive:this.analysisViewData.interactive,selected:this._selected}},a=>{const r=a!=null;this._forEachVisualElement(o=>o.attached=r),r&&this._updateVisualElements(a)},{initial:!0,equals:Mi}),M(()=>{const{viewshedComputedData:a}=this,{horizontalFieldOfView:r,verticalFieldOfView:o}=a??{};return{viewshedComputedData:a,horizontalFieldOfView:r,verticalFieldOfView:o}},({viewshedComputedData:a})=>{const{_shapeVisualElement:r}=this;a!==r.viewshedComputedData&&(r.viewshedComputedData=a),this._shapeVisualElement.recreateGeometry()},E),M(()=>{const{interactive:a}=this.analysisViewData;return{visible:this.visible,selected:a&&this._selected,staged:a&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}},({visible:a,selected:r,staged:o,horFovNot360:h})=>{const c=r||o;this._shapeVisualElement.visible=a,this._topArcVisualElement.visible=a,this._bottomArcVisualElement.visible=a,this._frameLinesVisualElement.visible=a&&h;const u=a&&(r||h);this._leftArcVisualElement.visible=u,this._rightArcVisualElement.visible=u,this._forEachLineVisualElement(n=>{n.width=c?J.frameWidthSelected:J.frameWidthNotSelected,n.renderOccluded=r?ne.OccludeAndTransparent:ne.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(n=>{n.width=2*(c?J.frameWidthSelected:J.frameWidthNotSelected),n.visible=a&&r})},E),M(()=>{const{analysisViewData:{interactive:a,tool:r},_selected:o,visible:h}=this,c=this.view.activeTool,u=!r?.active&&c instanceof Qe&&c.creating;return{observerVisible:h&&!o&&(!a||(r?.creating??!1)||u),color:this._color}},({observerVisible:a,color:r})=>{this._observerVisualElement.visible=a,this._forEachLineVisualElement(o=>o.color=r)},E)])}get _color(){const{viewshedComputedData:t,_selected:e,analysisViewData:i}=this;if(t==null)return ie.toUnitRGBA(J.frameColor);const a=i.tool?.active||i.interactive,r=t.viewshed===i.tool?.stagedViewshed,o=a&&(e||r)?this.view.effectiveTheme.accentColor:J.frameColor;return ie.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){const{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=x(this._observerVisualElement),this._shapeVisualElement=x(this._shapeVisualElement),this._frameLinesVisualElement=x(this._frameLinesVisualElement),this._leftArcVisualElement=x(this._leftArcVisualElement),this._rightArcVisualElement=x(this._rightArcVisualElement),this._topArcVisualElement=x(this._topArcVisualElement),this._bottomArcVisualElement=x(this._bottomArcVisualElement),this._centralLongitude=x(this._centralLongitude),this._centralLatitude=x(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){const{viewshedComputedData:e,corners:i,arcCenters:a,parallelCenters:r}=t,o=jt(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,i),this._updateFrameArcs(e,i,r),this._updateCentralHelperArcs(e,a)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,i){const{observerRenderSpace:a,rightVector:r,horizontalFieldOfView:o,tiltedUpVector:h}=t,c=y(o),u=p(),n=S();Q(n,c/2,h),G(u,r,n),he(this._leftArcVisualElement,a,e.bottomLeft,e.topLeft,"forward",u),Q(n,-c/2,h),K(u,0,0,0),G(u,r,n),he(this._rightArcVisualElement,a,e.bottomRight,e.topRight,"forward",u);const v=o>180?"backward":"forward";he(this._topArcVisualElement,i.top,e.topRight,e.topLeft,v,h),he(this._bottomArcVisualElement,i.bottom,e.bottomRight,e.bottomLeft,v,h)}_updateCentralHelperArcs(t,e){const i=t.observerRenderSpace,a=t.horizontalFieldOfView>=180?"backward":"forward";he(this._centralLatitude,i,e.right,e.left,a,t.tiltedUpVector),he(this._centralLongitude,i,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function he(s,t,e,i,a,r,o=Qt){const h=p();C(h,e,t);const c=me(h),u=p();C(u,i,t),ue(u,u),U(u,u,c);let n=ye(h,u);const v=jt(r);a==="backward"&&(Je(v,v),n=-(2*Math.PI-n));const w=[],f=Math.ceil(Math.abs(n)/o),m=S();Q(m,n/f,v);const D=p();k(D,h);const O=p();k(O,e);for(let A=0;A<f;A++){const P=p();k(P,O),G(D,D,m),X(O,t,D);const R=p();k(R,O),w.push([P,R])}s.geometry=w}l([d()],W.prototype,"view",void 0),l([d()],W.prototype,"analysisViewData",void 0),l([d()],W.prototype,"viewshedComputedData",void 0),l([d()],W.prototype,"visible",void 0),l([d()],W.prototype,"_color",null),l([d()],W.prototype,"_selected",null),l([d()],W.prototype,"_staged",null),W=l([se("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],W);const da=W;let re=class extends Ve{get visible(){return this.analysisViewData.visible}constructor(s){super(s)}initialize(){const s=this.analysisViewData,t=Ke(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:e})=>{const i=new da({view:this.view,viewshedComputedData:e,analysisViewData:s});return{visualization:i,remove:()=>i.destroy()}});this._viewshedVisualizations=t,this.addHandles([yi(t),M(()=>this.visible,e=>this._viewshedVisualizations.forEach(({visualization:i})=>i.visible=e),E)])}get test(){}};l([d({constructOnly:!0})],re.prototype,"analysisViewData",void 0),l([d({constructOnly:!0,nonNullable:!0})],re.prototype,"view",void 0),l([d({constructOnly:!0})],re.prototype,"isDecoration",void 0),l([d()],re.prototype,"visible",null),re=l([se("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],re);var Xe;let V=Xe=class extends Ve{constructor(s){super(s),this.observerRenderSpaceOverride=null}get observer(){return this.viewshed.observer??new Be}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,p())}get target(){const s=this.targetRenderSpace;return this.renderSpaceToPoint(s,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const s=C(p(),this.targetRenderSpace,this.observerRenderSpace);return ue(s,s)}get tiltedUpVector(){const s=te(p(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return ue(s,s)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const s=this._basis;return q(s[8],s[9],s[10])}get northVector(){const s=this._basis;return q(s[4],s[5],s[6])}get leftVector(){const s=this.upVector,t=te(p(),this.northVector,-y(this.heading),s);return Si(t,s,t)}get rightVector(){return Je(p(),this.leftVector)}clone(){return new Xe({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}isValid(){return this.viewshed.isValid()}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(s,t,e){const{observerRenderSpace:i,targetRenderSpace:a}=this,r=C(Le,a,i);return te(r,r,-y(t),this.leftVector),te(r,r,-y(s),this.tiltedUpVector),X(e,r,i)}cornerPoints(s){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(-t,e,s.topLeft),this.pointOnSphere(t,e,s.topRight),this.pointOnSphere(-t,-e,s.bottomLeft),this.pointOnSphere(t,-e,s.bottomRight)}arcCentersPoints(s){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(0,e,s.top),this.pointOnSphere(0,-e,s.bottom),this.pointOnSphere(-t,0,s.left),this.pointOnSphere(t,0,s.right)}parallelCenterPoints(s){const t=this.observerRenderSpace,e=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),i=U(Le,this.tiltedUpVector,e);X(s.top,t,i),C(s.bottom,t,i)}renderSpaceToPoint(s,t){const e=Le;return this.renderCoordsHelper.fromRenderCoords(s,e,t),new Be(e[0],e[1],e[2],t)}_pointToRenderSpace(s,t){const e=Oi(s.toArray());return this.renderCoordsHelper.toRenderCoords(e,s.spatialReference,t),t}_computeTargetRenderSpace(s){const{leftVector:t,northVector:e,upVector:i}=this,a=this.farDistanceRenderSpace,r=p();return U(r,e,a),te(r,r,-y(this.heading),i),te(r,r,-y(this.tiltParallelToSurface),t),X(r,s,r),r}};l([d()],V.prototype,"renderCoordsHelper",void 0),l([d()],V.prototype,"viewshed",void 0),l([d()],V.prototype,"observerRenderSpaceOverride",void 0),l([d()],V.prototype,"observer",null),l([d()],V.prototype,"effectiveObserverRenderSpace",null),l([d()],V.prototype,"effectiveObserver",null),l([d()],V.prototype,"effectiveTargetRenderSpace",null),l([d()],V.prototype,"farDistance",null),l([d()],V.prototype,"farDistanceRenderSpace",null),l([d()],V.prototype,"heading",null),l([d()],V.prototype,"tilt",null),l([d()],V.prototype,"feature",null),l([d()],V.prototype,"tiltParallelToSurface",null),l([d()],V.prototype,"horizontalFieldOfView",null),l([d()],V.prototype,"verticalFieldOfView",null),l([d()],V.prototype,"observerRenderSpace",null),l([d()],V.prototype,"target",null),l([d()],V.prototype,"targetRenderSpace",null),l([d()],V.prototype,"targetDirection",null),l([d()],V.prototype,"tiltedUpVector",null),l([d()],V.prototype,"_basis",null),l([d()],V.prototype,"upVector",null),l([d()],V.prototype,"northVector",null),l([d()],V.prototype,"leftVector",null),l([d()],V.prototype,"rightVector",null),l([d()],V.prototype,"isValid",null),l([d()],V.prototype,"metersPerUnit",null),V=Xe=l([se("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],V);const Le=p();let Z=class extends Di{constructor(){super(...arguments),this.sectionAngles=Ti()}get sectionAnglesDeg(){return rt(this.sectionAngles.map(t=>we(t)))}set sectionAnglesDeg(t){this.sectionAngles=rt(t.map(e=>y(e)))}get projectionMatrix(){return j(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const t=this.sectionAngles[0],e=this.sectionAngles[1],i=this.sectionAngles[2],a=this.sectionAngles[3];Ne(t<=e),Ne(i<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),h=Math.tan(t),c=Math.tan(e),u=Math.tan(i),n=c-h,v=Math.tan(a)-u,w=r/n,f=o/v,m=-(h+n/2)/r*2,D=-(u+v/2)/o*2,O=S();_e(O,[m,D,0]);const A=S();$e(A,[w,f,1]);const P=S();return j(P,A,O)}get _sectionRatioX(){const t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),i=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/i)}setViewport(t,e){const i=e*this._sectionRatioX;return this.viewport=[t[0],t[1],i,e],i}};l([d()],Z.prototype,"sectionAngles",void 0),l([d()],Z.prototype,"sectionAnglesDeg",null),l([d()],Z.prototype,"projectionMatrix",null),l([d()],Z.prototype,"sectionMatrix",null),l([d()],Z.prototype,"_sectionRatioX",null),Z=l([se("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class ua{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const Ie=["front","left","right","back","top","bottom"];function pa(s){return!["top","bottom"].includes(s)}let va=class{constructor(t){this._fbos=t,this._minTextureSize=16,this._faces={},this._width=0,this._height=0,this.settings=new ua,this._maxTextureSize=Math.min($i("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture()}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach(i=>{t[i]&&(e+=1)}),e}get faces(){const t=this._faces,e=[];for(const i of Ie){const a=t[i];a&&e.push(a)}return e}get atlasRegions(){return this.faces.map(t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(t=>t.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(t=>t.viewMatrix)}_setupFaceCamera(t,e,i,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:h,farDistanceRenderSpace:c,horizontalFieldOfView:u,verticalFieldOfView:n}=e,v=p();C(v,h,r);const w=p(),f=p(),m=(g,_)=>{const $=p(),it=S();return Q(it,g,_),G($,v,it),X($,r,$),$};let D,O=o;const A=Math.min(90,u),P=Math.min(90,Math.max(0,(u-90)/2));let R=-45,H=45,L=-45,N=45;if(pa(t)){const g=_=>Se(_,-45,45);L=g(-n/2)-this.settings.toleranceBottomTop,N=g(+n/2)+this.settings.toleranceBottomTop}switch(t){case"front":D=h,R=-A/2,H=A/2;break;case"left":D=m(Math.PI/2,o),R=45-P;break;case"right":D=m(-Math.PI/2,o),H=-45+P;break;case"top":D=X(w,r,o),O=Je(f,v);break;case"bottom":D=C(w,r,o),O=v;break;case"back":D=m(Math.PI,o)}const Y=new Z({center:D,eye:r,up:O,far:c});Y.sectionAnglesDeg=[R-this.settings.toleranceSides,H+this.settings.toleranceSides,L,N],Y.fovY=Math.PI/2;const b=Y.setViewport(i,a);return this._faces[t]=Y,b}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:i,verticalFieldOfView:a}=t,r=-a/2,o=a/2;return i===0||a===0||(r<=45&&o>=-45&&e.add("front"),i>90&&(e.add("left"),e.add("right")),i>270&&e.add("back"),o>45-this.settings.toleranceBottomTop&&e.add("top"),r<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize(t,e,i,a){const r=e/t.pixelRatio,o=this.settings.textureSizeModifier(i),h=Math.max(t.fullWidth,t.fullHeight),c=Ei(Math.floor(h*r*o)),u=Math.floor(this._maxTextureSize/a),n=Se(c,this._minTextureSize,u);return Ai(n)}_ensureFBO(t){const e=this._width,i=this._height;this._handle?.fbo?.width===e&&this._handle?.fbo?.height===i||(this._handle?.release(),this._handle=this._fbos.acquire(e,i,"viewshed shadow map",ot.RGBA4));const a=t?nt.DEPTH_STENCIL_TEXTURE:nt.DEPTH16_BUFFER;this._handle.acquireDepth(a)}clearFBO(t){const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer(this._handle?.fbo),e.setClearColor(1,1,1,1),e.clear(lt.COLOR|lt.DEPTH)}dispose(){this._handle=Ri(this._handle)}start(t,e,i,a,r=!1){this._faces={};const o=this._computeActiveFaces(e),h=o.size;if(h===0)return!1;const c=this._computeBaseTextureSize(t,a,i,h);let u=0,n=0,v=0;return Ie.filter(w=>o.has(w)).forEach(w=>{const f=wa(w,h);f>n&&(v=Math.max(v,u),u=0),n=f;const m=f*c;u+=this._setupFaceCamera(w,e,[u,m],c)}),v=Math.max(v,u),this._width=this.settings.textureResizeModulo(v),this._height=fa(h)*c,this.clearFBO(r),!0}finish(){this._handle?.detachDepth()}get test(){return{faces:this._faces,faceTypes:Ie,width:this._width,height:this._height,getFBO:()=>this._fbos.acquire(this._width,this._height,"viewshed shadow map",ot.RGBA4)}}};function wa(s,t){if(t<4)return 0;const e=s==="front"||s==="left";return t===4?e?0:1:e||s==="right"?0:1}function fa(s){return s<4?1:2}class ma extends xi{constructor(){super(...arguments),this.localOrigin=Ci()}}function ga(s){s.include(Pi),s.fragment.uniforms.add(new Fi("inverseViewMatrix",(t,e)=>{const i=Nt(S(),e.camera.viewMatrix,t.localOrigin);return Wt(i,i)})).code.add(Ge`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}class tt extends ma{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=ht.flat(),this.viewMatrices=ht.flat(),this.volumeOffset=0}}function Jt(){const s=new zi,t=s.fragment;return s.include(Hi),s.include(ga),s.include(Li),t.include(Ii),t.include(Ui),s.include(ki),t.uniforms.add(new ji("depthTexture",e=>e.depth?.attachment),new ct("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new ct("inverseViewNormalMatrix",({camera:e})=>Wt(_a,e.viewInverseTransposeMatrix)),new Ae("viewshedObserverOffset",e=>e.observerOffset),new Ae("viewshedTargetVector",e=>e.targetVector),new Ae("viewshedUpVector",e=>e.upVector),new Re("viewshedFOVs",e=>e.fovs),new Re("viewshedHeadingAndTilt",e=>e.headingAndTilt),new Re("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new Ni("viewshedVolumeOffset",e=>e.volumeOffset),new dt("viewshedShadowMap",e=>e.shadowMap.depthTexture),new ut("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new ut("viewshedViewMatrices",e=>e.viewMatrices,6),new Wi("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new Bi("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new dt("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(Ge`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return rgba4ToFloat(textureAtlasLookup(viewshedShadowMap, uv, atlasRegion));
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = vec3(-1.0) + 2.0 * normal4.xyz;
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(Ge`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),s}const _a=S(),Va=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:tt,build:Jt},Symbol.toStringTag,{value:"Module"}));class Pt extends Gi{constructor(t,e){super(t,e,new qi(Va,()=>Qi(()=>Promise.resolve().then(()=>Da),void 0)))}initializePipeline(){return Xi({colorWrite:Yi,blending:Ki})}}let B=class extends Ji{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(s=>ya(this.view,s))}constructor(s){super(s),this._passParameters=new tt,this._viewsheds=new Zi,this._shadowMap=null,this.consumes={required:[xe.VIEWSHED,"normals"]},this.produces=xe.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new va(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,s=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=s)},E),Ye(()=>!this.hasViewsheds,()=>this._shadowMap?.dispose()),M(()=>this._viewshedsInView.map(s=>[s.observerRenderSpace,s.heading,s.tilt,s.farDistance,s.horizontalFieldOfView,s.verticalFieldOfView]),()=>this.requestRender(pt.UPDATE),kt)])}destroy(){this._shadowMap=es(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Pt);for(const s of this._viewshedsInView)if(this._shadowMap?.isActive(s))return void this.view._stage.renderer.precompileViewshedShadowMap()}}render(s){const t=this.bindParameters,e=this.renderingContext,i=s.find(({name:o})=>o===xe.VIEWSHED);if(!this.hasViewsheds||!t.depth)return i;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=s.find(({name:o})=>o==="normals")?.getTexture();const a=this.techniques.get(Pt);if(!a?.compiled)return this.requestRender(pt.UPDATE),i;const r=this.view._stage.renderer.isFeatureEnabled(ts.HighResolutionViewshed);for(const o of this._viewshedsInView){if(!this._renderShadowCubeMap(t,o,r)||!this._shadowMap?.ready)continue;const h=this._setupViewshedParameters(o,t.camera);e.bindTechnique(a,t,h),e.bindFramebuffer(i.fbo),e.screen.draw()}return this.shadowMap?.dispose(),i}updateViewsheds(s){const t=this._viewsheds,{removes:e,adds:i}=s;if(e&&(Array.isArray(e)?t.removeMany(e):t.remove(e)),i)if(Array.isArray(i)){const a=i.filter(r=>!t.includes(r));t.addMany(a)}else t.includes(i)||t.add(i)}_renderShadowCubeMap(s,t,e){const i=this._shadowMap;if(!i)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=i.start(s.camera,t,e,this._contentPixelRatio,a);return r&&i.faces.forEach(o=>this.view._stage.renderer.renderViewshedShadowMap(o)),i.finish(),r}_setupViewshedParameters(s,t){const e=this._shadowMap;if(!e)return this._passParameters;const i=this._passParameters,a=s.effectiveObserverRenderSpace;i.localOrigin=a,i.observerOffset=C(Oa,s.observerRenderSpace,s.effectiveObserverRenderSpace),i.fovs=[y(s.horizontalFieldOfView),y(s.verticalFieldOfView)],i.headingAndTilt=[y(s.heading),y(s.tiltParallelToSurface)],i.upVector=s.tiltedUpVector;const r=ba(s.targetRenderSpace,a);i.targetVector=r;const o=new Array,h=new Array;for(let c=0;c<e.numActiveFaces;c++)Nt(Ue,e.viewshedViewMatrices[c],a),o.push(...Ue),Ma(e.viewshedProjectionMatrices[c],Ue,Ft),h.push(...Ft);return i.viewMatrices=o,i.projectionMatrices=h,i.volumeOffset=this.selectedViewshed?.()===s.viewshed?Sa(s,this.view,t.eye):0,i}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function ba(s,t){const e=p();return C(e,s,t)}function Ma(s,t,e){const i=q(.5,.5,.5);return _e(e,i),ss(e,e,i),j(e,e,s),j(e,e,t),e}function ya(s,t){const e=is(t.observerRenderSpace,t.farDistanceRenderSpace);return!!s.ready&&s.frustum.intersectsSphere(e)}function Sa(s,t,e){if(s==null)return 0;const{observerRenderSpace:i,targetRenderSpace:a}=s,r=vt(e,i)>vt(e,a)?s.observer:s.target;return t.pixelSizeAt(r)}l([d()],B.prototype,"selectedViewshed",void 0),l([d()],B.prototype,"shadowMap",null),l([d()],B.prototype,"hasViewsheds",null),l([d()],B.prototype,"_contentPixelRatio",null),l([d()],B.prototype,"_viewshedsInView",null),l([d()],B.prototype,"consumes",void 0),l([d()],B.prototype,"produces",void 0),B=l([se("esri.views.3d.webgl-engine.lib.Viewshed")],B);const Oa=p(),Ue=S(),Ft=S();let F=class extends us(Ve){constructor(s){super(s),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this._placementTask=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(s){this._unselectOtherViewsheds(s),this._selectedViewshed=s}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}initialize(){const s=this.view;this._viewshedRenderer=new B({view:s,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed}),this._intersector=as(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=rs.MIN,this.viewshedComputedDataHandles=Ke(()=>this.analysis.viewsheds,t=>{const e=new V({renderCoordsHelper:s.renderCoordsHelper,viewshed:t}),i=Symbol();return this.addHandles([M(()=>({valid:e.isValid(),canProject:ns(e.observer?.spatialReference,this.view.spatialReference)||ls()}),({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(e):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(e),r||vs(this.analysis,e.observer.spatialReference,os.getLogger(this)))},E),M(()=>[s.state.camera,s.slicePlane,e.viewshed.observer,e.targetRenderSpace,e.verticalFieldOfView,e.horizontalFieldOfView,e.feature],()=>{this._updateObserverFromFeature(s,e)},E)]),{viewshedComputedData:e,remove:()=>{this.removeHandles(i),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._analysisVisualization=new re({view:s,analysisViewData:this,isDecoration:!this.parent}),this.addHandles([M(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles;if(e==null)return;t||(this.selectedViewshed=null);const i=e.map(a=>a.viewshedComputedData).filter(a=>a.isValid()).toArray();t?this._addViewshedsToRenderer(i):this._removeViewshedsFromRenderer(i)}),M(()=>s.renderCoordsHelper,t=>{this.viewshedComputedDataHandles?.forEach(({viewshedComputedData:e})=>e.renderCoordsHelper=t)}),As(this,Qe),Ye(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},de)])}destroy(){this._placementTask=De(this._placementTask),Rs(this),this._analysisVisualization=x(this._analysisVisualization);const s=this.viewshedComputedDataHandles;s!=null&&this._removeViewshedsFromRenderer(s.map(t=>t.viewshedComputedData).toArray())}async createViewsheds(s){return this._placementTask=De(this._placementTask),this._placementTask=xs(this,s),this.tool!=null&&this.tool.createViewsheds(),await this._placementTask.promise}_addViewshedsToRenderer(s){this._viewshedRenderer.updateViewsheds({adds:s})}_removeViewshedsFromRenderer(s){this._viewshedRenderer.updateViewsheds({removes:s})}_updateObserverFromFeature(s,t){const e=t.observerRenderSpace,i=t.targetRenderSpace,a=k(p(),e),r={observer:e,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:cs(t.feature),target:i,targetSurfaceNormal:null,targetAdjusted:k(p(),i),targetFeatureId:null};ds(s,this._intersector,r,o=>Math.min(o,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=hs(a,e)?null:a}_unselectOtherViewsheds(s){if(s!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof Qe&&(t.analysisViewData.selectedViewshed=null)}get test(){}};l([d({readOnly:!0})],F.prototype,"type",void 0),l([d({constructOnly:!0,nonNullable:!0})],F.prototype,"analysis",void 0),l([d()],F.prototype,"tool",void 0),l([d()],F.prototype,"_selectedViewshed",void 0),l([d()],F.prototype,"selectedViewshed",null),l([d()],F.prototype,"selectedViewshedComputedData",null),l([d()],F.prototype,"viewshedComputedDataHandles",void 0),l([d()],F.prototype,"_analysisVisualization",void 0),l([d()],F.prototype,"_placementTask",void 0),l([d()],F.prototype,"_viewshedRenderer",void 0),F=l([se("esri.views.3d.analysis.ViewshedAnalysisView3D")],F);const rr=F,Da=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:tt,build:Jt},Symbol.toStringTag,{value:"Module"}));export{rr as default};
