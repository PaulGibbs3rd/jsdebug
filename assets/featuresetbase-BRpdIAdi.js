import{jS as P,ed as Te,jV as A,bc as de,dt as De,iF as he,c7 as Z,jW as xe,gH as Ee,aC as Ne}from"./index-CzvLtnX1.js";import{u as x,z as Ae,F as X,B as v,C as j,y as E,N as ve,J as ue,K as ce,Q as me,M as L,Z as V,H as K,O as Se,g as W,G as Le,b as G,D as Ce,P as Ze,R as q,S as $}from"./arcade-BgB3Zzbi.js";import{a as y,r as p}from"./unitConversion-DnvB3s42.js";import{R as ke,q as ye,p as Pe,c as ee,e as je,a as Re,b as Ue,N as J,j as Me,F as Oe,E as ze,L as H,B as He,d as Q,f as C,k as ne}from"./featureSetUtils-4ebZdJw5.js";import{t as We}from"./ImmutableArray-BPVd6ESQ.js";import{l as Ve}from"./portalUtils-Be2eERd8.js";import{u as Ge,O as pe}from"./SpatialFilter-BGmVjCxK.js";import{x as we,s as te}from"./shared-BuUhWXQe.js";import{D}from"./WhereClause-D7Picv4q.js";import{queryAssociations as _e}from"./queryAssociations-DbN0_do5.js";import Be from"./QueryAssociationsParameters-B-42fvec.js";import"./number-Caga42RA.js";import"./TimeOnly-DUjwkvaH.js";import"./hash-CcEbRgUF.js";import"./operatorsWorkerConnection-Dv_VDixR.js";import"./Association-DFLDc9x-.js";function Ke(a){if(a.length===1){if(A(a[0]))return $("distinct",a[0],-1);if(W(a[0]))return $("distinct",a[0].toArray(),-1)}return $("distinct",a,-1)}function ie(a,n,i){const g=a.getVariables();if(g.length>0){const I={};for(const e of g)I[e]=n.evaluateIdentifier(i,{name:e});a.parameters=I}return a}function c(a,n,i=null){for(const g in a)if(g.toLowerCase()===n.toLowerCase())return a[g];return i}function ge(a){if(a===null)return null;const n={type:c(a,"type",""),name:c(a,"name","")};if(n.type==="range")n.range=c(a,"range",[]);else{n.codedValues=[];for(const i of c(a,"codedValues",[]))n.codedValues.push({name:c(i,"name",""),code:c(i,"code",null)})}return n}function ae(a){if(a===null)return null;const n={},i=c(a,"wkt");i!==null&&(n.wkt=i);const g=c(a,"wkid");return g!==null&&(n.wkid=g),n}function Ie(a){if(a===null)return null;const n={hasZ:c(a,"hasz",!1),hasM:c(a,"hasm",!1)},i=c(a,"spatialreference");i!=null&&(n.spatialReference=ae(i));const g=c(a,"x",null);if(g!==null)return n.x=g,n.y=c(a,"y",null),n.hasZ&&(n.z=c(a,"z",null)),n.hasM&&(n.m=c(a,"m",null)),n;const I=c(a,"rings",null);if(I!==null)return n.rings=I,n;const e=c(a,"paths",null);if(e!==null)return n.paths=e,n;const t=c(a,"points",null);if(t!==null)return n.points=t,n;for(const s of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const o=c(a,s,null);o!==null&&(n[s]=o)}return n}function qe(a,n){for(const i of n)if(i===a)return!0;return!1}function Qe(a){return!!a.layerDefinition&&!!a.featureSet&&qe(a.layerDefinition.geometryType,["",null,"esriGeometryNull","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])!==!1&&A(a.layerDefinition.fields)!==!1&&A(a.featureSet.features)!==!1}function _(a){return a?.toLowerCase()==="utc"?"UTC":a?.toLowerCase()==="unknown"?"Unknown":a}async function Je(a,n,i,g,I,e,t){const s=await a.getFeatureSetInfo();if((s?.layerId??null)===null||!I.layerIdLookup.get(s.layerId))return null;const o=a.serviceUrl().replace(/\/FeatureServer/i,"/UtilityNetworkServer"),m=[];switch(i){case"connected":m.push("connectivity"),m.push("junction-edge-from-connectivity"),m.push("junction-edge-to-connectivity"),m.push("junction-edge-midspan-connectivity"),m.push("junction-junction-connectivity");break;case"container":case"content":m.push("containment");break;case"structure":case"attached":m.push("attachment");break;case"junctionedge":m.push("junction-edge-from-connectivity"),m.push("junction-edge-to-connectivity");break;case"midspan":m.push("junction-edge-midspan-connectivity");break;default:throw new y(e,p.InvalidParameter,t)}let d=null,l=!1;if(g!==null&&g!==""&&g!==void 0){for(const u of I.terminals)u.terminalName===g&&(d=u.terminalId);d===null&&(l=!0)}const r=[];if(!l){const u=new Ee({globalId:n.field(a.globalIdField),networkSourceId:I.layerIdLookup.get(s.layerId).sourceId,...d?{terminalId:d}:""}),N=await _e(o,new Be({types:m,elements:[u]}));let T=0;for(const w of N.associations){let b=null,M="",k="";if(w.fromNetworkElement?.globalId===u.globalId?(b=w.toNetworkElement,k="to"):w.toNetworkElement?.globalId===u.globalId&&(b=w.fromNetworkElement,k="from"),!b)continue;switch(i){case"attached":if(w.associationType!=="attachment"||k!=="to")continue;break;case"structure":if(w.associationType!=="attachment"||k!=="from")continue;break;case"container":if(w.associationType!=="containment"||k!=="from")continue;break;case"content":if(w.associationType!=="containment"||k!=="to")continue;break;case"connected":break;case"junctionedge":w.associationType==="junction-edge-to-connectivity"?M="to":w.associationType==="junction-edge-from-connectivity"&&(M="from");break;case"midspan":if(w.associationType!=="junction-edge-midspan-connectivity")continue}const O=I.sourceIdLookup.get(b.networkSourceId)?.className??"";r.push(new Ne({geometry:null,attributes:{objectId:T++,globalId:b.globalId,percentAlong:w.percentAlong??0,isContentVisible:w.isContentVisible?0:1,className:O,side:M}}))}}const f=new he({source:r,geometryType:null,objectIdField:"objectId",globalIdField:"globalId",fields:[new Z({name:"objectId",alias:"objectId",type:"oid"}),new Z({name:"globalId",alias:"globalId",type:"global-id"}),new Z({name:"percentAlong",alias:"percentAlong",type:"double"}),new Z({name:"side",alias:"side",type:"string"}),new Z({name:"isContentVisible",alias:"isContentVisible",type:"integer"}),new Z({name:"className",alias:"className",type:"string"})]});return J(f)}function yn(a){a.mode==="async"&&(a.functions.timezone=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,1,2,n,i),Ae(e[0])||X(e[0]))return"Unknown";if(v(e[0])){if(await e[0].load(),e.length===1||e[1]===null)return e[0].datesInUnknownTimezone?_("unknown"):_(e[0].dateFieldsTimeZone);if(!(e[1]instanceof j)||e[1].hasField("type")===!1)throw new y(n,p.InvalidParameter,i);const o=e[1].field("type");if(P(o)===!1)throw new y(n,p.InvalidParameter,i);switch(E(o).toLowerCase()){case"preferredtimezone":return _(e[0].preferredTimeZone);case"editfieldsinfo":return _(e[0].editFieldsInfo?.timeZone??null);case"timeinfo":return _(e[0].timeInfo?.timeZone??null);case"field":if(e[1].hasField("fieldname")&&P(e[1].field("fieldname")))return _(e[0].fieldTimeZone(E(e[1].field("fieldname"))))}throw new y(n,p.InvalidParameter,i)}const t=ve(e[0],ue(n));if(t===null)return null;const s=t.timeZone;return s==="system"?Te.systemTimeZoneCanonicalName:s.toLowerCase()==="utc"?"UTC":s.toLowerCase()==="unknown"?"Unknown":s})},a.functions.sqltimestamp=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{x(e,1,3,n,i);const t=e[0];if(ce(t)){if(e.length===1)return t.toSQLWithKeyword();if(e.length===2)return t.changeTimeZone(E(e[1])).toSQLWithKeyword();throw new y(n,p.InvalidParameter,i)}if(X(t))return t.toSQLWithKeyword();if(v(t)){if(e.length!==3)throw new y(n,p.InvalidParameter,i);await t.load();const s=E(e[1]);if(X(e[2]))return e[2].toSQLWithKeyword();if(ce(e[2])===!1)throw new y(n,p.InvalidParameter,i);const o=t.fieldTimeZone(s);return o==null?e[2].toSQLWithKeyword():e[2].changeTimeZone(o).toSQLWithKeyword()}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"sqltimestamp",min:2,max:4}),a.functions.featuresetbyid=function(n,i){return a.standardFunctionAsync(n,i,(g,I,e)=>{if(x(e,2,4,n,i),me(e[0])){const t=E(e[1]);let s=L(e[2],null);const o=V(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(n,p.InvalidParameter,i);return e[0].featureSetById(t,o,s)}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyid",min:2,max:4}),a.functions.getfeatureset=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,1,2,n,i),K(e[0])){let t=L(e[1],"datasource");return t===null&&(t="datasource"),t=E(t).toLowerCase(),ke(e[0].fullSchema(),t,n.lrucache,n.interceptor,n.spatialReference??null)}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"getfeatureset",min:1,max:2}),a.functions.featuresetbyportalitem=function(n,i){return a.standardFunctionAsync(n,i,(g,I,e)=>{if(x(e,2,5,n,i),e[0]===null)throw new y(n,p.PortalRequired,i);if(e[0]instanceof Se){const d=E(e[1]),l=E(e[2]);let r=L(e[3],null);const f=V(L(e[4],!0));if(r===null&&(r=["*"]),A(r)===!1)throw new y(n,p.InvalidParameter,i);let u;return u=n.services?.portal?n.services.portal:de.getDefault(),u=Ve(e[0],u),ye(d,l,n.spatialReference??null,r,f,u,n.lrucache,n.interceptor)}if(P(e[0])===!1)throw new y(n,p.PortalRequired,i);const t=E(e[0]),s=E(e[1]);let o=L(e[2],null);const m=V(L(e[3],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new y(n,p.InvalidParameter,i);return ye(t,s,n.spatialReference??null,o,m,n.services?.portal??de.getDefault(),n.lrucache,n.interceptor)})},a.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),a.functions.featuresetbyname=function(n,i){return a.standardFunctionAsync(n,i,(g,I,e)=>{if(x(e,2,4,n,i),me(e[0])){const t=E(e[1]);let s=L(e[2],null);const o=V(L(e[3],!0));if(s===null&&(s=["*"]),A(s)===!1)throw new y(n,p.InvalidParameter,i);return e[0].featureSetByName(t,o,s)}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"featuresetbyname",min:2,max:4}),a.functions.featureset=function(n,i){return a.standardFunction(n,i,(g,I,e)=>{x(e,1,1,n,i);const t={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",hasM:!1,hasZ:!1,fields:[]},featureSet:{geometryType:"",features:[]}};if(P(e[0])){const s=JSON.parse(e[0]);s.layerDefinition!==void 0?(t.layerDefinition=s.layerDefinition,t.featureSet=s.featureSet,s.layerDefinition.spatialReference&&(t.layerDefinition.spatialReference=s.layerDefinition.spatialReference)):(t.featureSet.features=s.features,t.featureSet.geometryType=s.geometryType,t.layerDefinition.geometryType=t.featureSet.geometryType,t.layerDefinition.objectIdField=s.objectIdFieldName??"",t.layerDefinition.typeIdField=s.typeIdFieldName,t.layerDefinition.globalIdField=s.globalIdFieldName,t.layerDefinition.fields=s.fields,s.spatialReference&&(t.layerDefinition.spatialReference=s.spatialReference))}else{if(!(e[0]instanceof j))throw new y(n,p.InvalidParameter,i);{const s=JSON.parse(e[0].castToText(!0)),o=c(s,"layerdefinition");if(o!==null){t.layerDefinition.geometryType=c(o,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.globalIdField=c(o,"globalidfield",""),t.layerDefinition.objectIdField=c(o,"objectidfield",""),t.layerDefinition.typeIdField=c(o,"typeidfield",""),t.layerDefinition.hasZ=c(o,"hasz",!1)===!0,t.layerDefinition.hasM=c(o,"hasm",!1)===!0;const m=c(o,"spatialreference");m&&(t.layerDefinition.spatialReference=ae(m));const d=[];for(const r of c(o,"fields",[])){const f={name:c(r,"name",""),alias:c(r,"alias",""),type:c(r,"type",""),nullable:c(r,"nullable",!0),editable:c(r,"editable",!0),length:c(r,"length",null),domain:ge(c(r,"domain"))};d.push(f)}t.layerDefinition.fields=d;const l=c(s,"featureset");if(l){const r={};for(const f of d)r[f.name.toLowerCase()]=f.name;for(const f of c(l,"features",[])){const u={},N=c(f,"attributes",{});for(const T in N)u[r[T.toLowerCase()]]=N[T];t.featureSet.features.push({attributes:u,geometry:Ie(c(f,"geometry"))})}}}else{t.layerDefinition.hasZ=c(s,"hasz",!1)===!0,t.layerDefinition.hasM=c(s,"hasm",!1)===!0,t.layerDefinition.geometryType=c(s,"geometrytype",""),t.featureSet.geometryType=t.layerDefinition.geometryType,t.layerDefinition.objectIdField=c(s,"objectidfieldname",""),t.layerDefinition.typeIdField=c(s,"typeidfieldname","");const m=c(s,"spatialreference");m&&(t.layerDefinition.spatialReference=ae(m));const d=[],l=c(s,"fields",null);if(!A(l))throw new y(n,p.InvalidParameter,i);for(const u of l){const N={name:c(u,"name",""),alias:c(u,"alias",""),type:c(u,"type",""),nullable:c(u,"nullable",!0),editable:c(u,"editable",!0),length:c(u,"length",null),domain:ge(c(u,"domain"))};d.push(N)}t.layerDefinition.fields=d;const r={};for(const u of d)r[u.name.toLowerCase()]=u.name;let f=c(s,"features",null);if(A(f))for(const u of f){const N={},T=c(u,"attributes",{});for(const w in T)N[r[w.toLowerCase()]]=T[w];t.featureSet.features.push({attributes:N,geometry:Ie(c(u,"geometry",null))})}else f=null,t.featureSet.features=f}}}if(Qe(t)===!1)throw new y(n,p.InvalidParameter,i);return t.layerDefinition.geometryType||(t.layerDefinition.geometryType="esriGeometryNull"),Pe.create(t,n.spatialReference)})},a.signatures.push({name:"featureset",min:1,max:1}),a.functions.filter=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,2,2,n,i),A(e[0])||W(e[0])){const t=[];let s,o=e[0];if(o instanceof We&&(o=o.toArray()),!Le(e[1]))throw new y(n,p.InvalidParameter,i);s=e[1].createFunction(n);for(const m of o){const d=s(m);De(d)?await d===!0&&t.push(m):d===!0&&t.push(m)}return t}if(v(e[0])){const t=await e[0].load(),s=D.create(e[1],{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),o=s.getVariables();if(o.length>0){const m={};for(const d of o)m[d]=a.evaluateIdentifier(n,{name:d});s.parameters=m}return new ee({parentfeatureset:e[0],whereclause:s})}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"filter",min:2,max:2}),a.functions.orderby=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,2,2,n,i),v(e[0])){const t=new je(e[1]);return new Re({parentfeatureset:e[0],orderbyclause:t})}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"orderby",min:2,max:2}),a.functions.top=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,2,2,n,i),v(e[0]))return new Ue({parentfeatureset:e[0],topnum:e[1]});if(A(e[0]))return G(e[1])>=e[0].length?e[0].slice():e[0].slice(0,G(e[1]));if(W(e[0]))return G(e[1])>=e[0].length()?e[0].slice():e[0].slice(0,G(e[1]));throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"top",min:2,max:2}),a.functions.first=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,1,1,n,i),v(e[0])){const t=await e[0].first(g.abortSignal);if(t!==null){const s=Ce.createFromGraphicLikeObject(t.geometry,t.attributes,e[0],n.timeZone);return s._underlyingGraphic=t,s}return t}return A(e[0])?e[0].length===0?null:e[0][0]:W(e[0])?e[0].length()===0?null:e[0].get(0):null})},a.signatures.push({name:"first",min:1,max:1}),a.functions.attachments=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{x(e,1,2,n,i);const t={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(e.length>1){if(e[1]instanceof j){if(e[1].hasField("minsize")&&(t.minsize=G(e[1].field("minsize"))),e[1].hasField("metadata")&&(t.returnMetadata=V(e[1].field("metadata"))),e[1].hasField("maxsize")&&(t.maxsize=G(e[1].field("maxsize"))),e[1].hasField("types")){const s=Ze(e[1].field("types"),!1);s.length>0&&(t.types=s)}}else if(e[1]!==null)throw new y(n,p.InvalidParameter,i)}if(K(e[0])){const s=e[0]._layer;let o;if(v(s))o=s;else{if(s==null||!we(s))return[];o=J(s,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}return await o.load(),o.queryAttachments(e[0].field(o.objectIdField),t.minsize,t.maxsize,t.types,t.returnMetadata)}if(e[0]===null)return[];throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"attachments",min:1,max:2}),a.functions.featuresetbyrelationshipname=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{x(e,2,4,n,i);const t=e[0],s=E(e[1]);let o=L(e[2],null);const m=V(L(e[3],!0));if(o===null&&(o=["*"]),A(o)===!1)throw new y(n,p.InvalidParameter,i);if(e[0]===null)return null;if(!K(e[0]))throw new y(n,p.InvalidParameter,i);const d=t._layer;let l;if(v(d))l=d;else{if(d==null||!we(d))return null;l=J(d,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)}l=await l.load();const r=l.relationshipMetaData().filter(w=>w.name===s);if(r.length===0)return null;if(r[0].relationshipTableId!==void 0&&r[0].relationshipTableId!==null&&r[0].relationshipTableId>-1)return Me(l,r[0],t.field(l.objectIdField),l.spatialReference,o,m,n.lrucache,n.interceptor);let f=l.serviceUrl();if(!f)return null;f=f.charAt(f.length-1)==="/"?f+r[0].relatedTableId.toString():f+"/"+r[0].relatedTableId.toString();const u=await Oe(f,l.spatialReference,o,m,n.lrucache,n.interceptor);await u.load();let N=u.relationshipMetaData();if(N=N.filter(w=>w.id===r[0].id),t.hasField(r[0].keyField)===!1||t.field(r[0].keyField)===null){const w=await l.getFeatureByObjectId(t.field(l.objectIdField),[r[0].keyField]);if(w){const b=D.create(N[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return b.parameters={id:w.attributes[r[0].keyField]},u.filter(b)}return new Ge({parentfeatureset:u})}const T=D.create(N[0].keyField+"= @id",{fieldsIndex:u.getFieldsIndex(),timeZone:u.dateFieldsTimeZoneDefaultUTC});return T.parameters={id:t.field(r[0].keyField)},u.filter(T)})},a.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),a.functions.featuresetbyassociation=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{x(e,2,3,n,i);const t=e[0],s=E(L(e[1],"")).toLowerCase(),o=P(e[2])?E(e[2]):null;if(e[0]===null)return null;if(!K(e[0]))throw new y(n,p.InvalidParameter,i);let m=t._layer;if(m instanceof he&&(m=J(m,n.spatialReference,["*"],!0,n.lrucache,n.interceptor)),m===null||v(m)===!1)return null;await m.load();const d=m.serviceUrl(),l=await ze(d,n.spatialReference,!0);if(l.unVersion>=8)return await Je(m,t,s,o,l,n,i);const r=l.associations;let f=null,u=null,N=!1;if(o!==null&&o!==""&&o!==void 0){for(const F of l.terminals)F.terminalName===o&&(u=F.terminalId);u===null&&(N=!0)}const T=r.getFieldsIndex(),w=T.get("TOGLOBALID").name,b=T.get("FROMGLOBALID").name,M=T.get("TOTERMINALID").name,k=T.get("FROMTERMINALID").name,O=T.get("FROMNETWORKSOURCEID").name,B=T.get("TONETWORKSOURCEID").name,z=T.get("ASSOCIATIONTYPE").name,Fe=T.get("ISCONTENTVISIBLE").name,be=T.get("OBJECTID").name;for(const F of m.fields)if(F.type==="global-id"){f=t.field(F.name);break}let R=null,re=new H(new Z({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),se=new H(new Z({name:"side",alias:"side",type:"string"}),D.create("''",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));const S="globalid",le="globalId",oe={};for(const F in l.lkp)oe[F]=l.lkp[F].sourceId;const U=new He(new Z({name:"classname",alias:"classname",type:"string"}),null,oe);let h="";switch(s){case"midspan":{h=`((${w}='${f}') OR ( ${b}='${f}')) AND (${z} IN (5))`,U.codefield=D.create(`CASE WHEN (${w}='${f}') THEN ${O} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=te(C.findField(r.fields,b));F.name=S,F.alias=S,R=new H(F,D.create(`CASE WHEN (${b}='${f}') THEN ${w} ELSE ${b} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),re=l.unVersion>=4?new ne(C.findField(r.fields,T.get("PERCENTALONG").name)):new H(new Z({name:"percentalong",alias:"percentalong",type:"double"}),D.create("0",{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"junctionedge":{h=`((${w}='${f}') OR ( ${b}='${f}')) AND (${z} IN (4,6))`,U.codefield=D.create(`CASE WHEN (${w}='${f}') THEN ${O} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const F=te(C.findField(r.fields,b));F.name=S,F.alias=S,R=new H(F,D.create(`CASE WHEN (${b}='${f}') THEN ${w} ELSE ${b} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC})),se=new H(new Z({name:"side",alias:"side",type:"string"}),D.create(`CASE WHEN (${z}=4) THEN 'from' ELSE 'to' END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"connected":{let F=`${w}='@T'`,fe=`${b}='@T'`;u!==null&&(F+=` AND ${M}=@A`,fe+=` AND ${k}=@A`),h="(("+F+") OR ("+fe+"))",h=q(h,"@T",f??""),F=q(F,"@T",f??""),u!==null&&(F=q(F,"@A",u.toString()),h=q(h,"@A",u.toString())),U.codefield=D.create("CASE WHEN "+F+` THEN ${O} ELSE ${B} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC});const Y=te(C.findField(r.fields,b));Y.name=S,Y.alias=S,R=new H(Y,D.create("CASE WHEN "+F+` THEN ${b} ELSE ${w} END`,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}));break}case"container":h=`${w}='${f}' AND ${z} = 2`,u!==null&&(h+=` AND ${M} = `+u.toString()),U.codefield=O,h="( "+h+" )",R=new Q(C.findField(r.fields,b),S,S);break;case"content":h=`(${b}='${f}' AND ${z} = 2)`,u!==null&&(h+=` AND ${k} = `+u.toString()),U.codefield=B,h="( "+h+" )",R=new Q(C.findField(r.fields,w),S,S);break;case"structure":h=`(${w}='${f}' AND ${z} = 3)`,u!==null&&(h+=` AND ${M} = `+u.toString()),U.codefield=O,h="( "+h+" )",R=new Q(C.findField(r.fields,b),S,le);break;case"attached":h=`(${b}='${f}' AND ${z} = 3)`,u!==null&&(h+=` AND ${k} = `+u.toString()),U.codefield=B,h="( "+h+" )",R=new Q(C.findField(r.fields,w),S,le);break;default:throw new y(n,p.InvalidParameter,i)}return N&&(h="1 <> 1"),new C({parentfeatureset:r,adaptedFields:[new ne(C.findField(r.fields,be)),new ne(C.findField(r.fields,Fe)),R,se,U,re],extraFilter:h?D.create(h,{fieldsIndex:r.getFieldsIndex(),timeZone:r.dateFieldsTimeZoneDefaultUTC}):null})})},a.signatures.push({name:"featuresetbyassociation",min:2,max:6}),a.functions.groupby=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,3,3,n,i),!v(e[0]))throw new y(n,p.InvalidParameter,i);const t=await e[0].load(),s=[],o=[];let m=!1,d=[];if(P(e[1]))d.push(e[1]);else if(e[1]instanceof j)d.push(e[1]);else if(A(e[1]))d=e[1];else{if(!W(e[1]))throw new y(n,p.InvalidParameter,i);d=e[1].toArray()}for(const l of d)if(P(l)){const r=D.create(E(l),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),f=pe(r)===!0?E(l):"%%%%FIELDNAME";s.push({name:f,expression:r}),f==="%%%%FIELDNAME"&&(m=!0)}else{if(!(l instanceof j))throw new y(n,p.InvalidParameter,i);{const r=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",f=l.hasField("expression")?l.field("expression"):"";if(r==="%%%%FIELDNAME"&&(m=!0),!r)throw new y(n,p.InvalidParameter,i);s.push({name:r,expression:D.create(f||r,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(d=[],P(e[2]))d.push(e[2]);else if(A(e[2]))d=e[2];else if(W(e[2]))d=e[2].toArray();else{if(!(e[2]instanceof j))throw new y(n,p.InvalidParameter,i);d.push(e[2])}for(const l of d){if(!(l instanceof j))throw new y(n,p.InvalidParameter,i);{const r=l.hasField("name")?l.field("name"):"",f=l.hasField("statistic")?l.field("statistic"):"",u=l.hasField("expression")?l.field("expression"):"";if(!r||!f||!u)throw new y(n,p.InvalidParameter,i);o.push({name:r,statistic:f.toLowerCase(),expression:D.create(u,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const l={};for(const f of t.fields)l[f.name.toLowerCase()]=1;for(const f of s)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);for(const f of o)f.name!=="%%%%FIELDNAME"&&(l[f.name.toLowerCase()]=1);let r=0;for(const f of s)if(f.name==="%%%%FIELDNAME"){for(;l["field_"+r.toString()]===1;)r++;l["field_"+r.toString()]=1,f.name="FIELD_"+r.toString()}}for(const l of s)ie(l.expression,a,n);for(const l of o)ie(l.expression,a,n);return e[0].groupby(s,o)})},a.signatures.push({name:"groupby",min:3,max:3}),a.functions.distinct=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(v(e[0])){x(e,2,2,n,i);const t=await e[0].load(),s=[];let o=[];if(P(e[1]))o.push(e[1]);else if(e[1]instanceof j)o.push(e[1]);else if(A(e[1]))o=e[1];else{if(!W(e[1]))throw new y(n,p.InvalidParameter,i);o=e[1].toArray()}let m=!1;for(const d of o)if(P(d)){const l=D.create(E(d),{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC}),r=pe(l)===!0?E(d):"%%%%FIELDNAME";s.push({name:r,expression:l}),r==="%%%%FIELDNAME"&&(m=!0)}else{if(!(d instanceof j))throw new y(n,p.InvalidParameter,i);{const l=d.hasField("name")?d.field("name"):"%%%%FIELDNAME",r=d.hasField("expression")?d.field("expression"):"";if(l==="%%%%FIELDNAME"&&(m=!0),!l)throw new y(n,p.InvalidParameter,i);s.push({name:l,expression:D.create(r||l,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC})})}}if(m){const d={};for(const r of t.fields)d[r.name.toLowerCase()]=1;for(const r of s)r.name!=="%%%%FIELDNAME"&&(d[r.name.toLowerCase()]=1);let l=0;for(const r of s)if(r.name==="%%%%FIELDNAME"){for(;d["field_"+l.toString()]===1;)l++;d["field_"+l.toString()]=1,r.name="FIELD_"+l.toString()}}for(const d of s)ie(d.expression,a,n);return e[0].groupby(s,[])}return Ke(e)})},a.functions.getfeaturesetinfo=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,1,1,n,i),!v(e[0]))return null;const t=await e[0].getFeatureSetInfo();return t?j.convertObjectToArcadeDictionary({layerId:t.layerId,layerName:t.layerName,itemId:t.itemId,serviceLayerUrl:t.serviceLayerUrl,webMapLayerId:t.webMapLayerId??null,webMapLayerTitle:t.webMapLayerTitle??null,className:null,objectClassId:null},ue(n),!1,!1):null})},a.signatures.push({name:"getfeaturesetinfo",min:1,max:1}),a.functions.filterbysubtypecode=function(n,i){return a.standardFunctionAsync(n,i,async(g,I,e)=>{if(x(e,2,2,n,i),v(e[0])){const t=await e[0].load(),s=e[1];if(!xe(s))throw new y(n,p.InvalidParameter,i);if(t.subtypeField){const m=D.create(`${t.subtypeField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:m})}if(t.typeIdField===null||t.typeIdField==="")throw new y(n,p.FeatureSetDoesNotHaveSubtypes,i);const o=D.create(`${t.typeIdField}= ${e[1]}`,{fieldsIndex:t.getFieldsIndex(),timeZone:t.dateFieldsTimeZoneDefaultUTC});return new ee({parentfeatureset:e[0],whereclause:o})}throw new y(n,p.InvalidParameter,i)})},a.signatures.push({name:"filterbysubtypecode",min:2,max:2}))}export{yn as registerFunctions};
