import{kY as N,b as d,m as p,kZ as U,ft as S,c as j,aP as V,ex as I,aW as Q,k_ as W,b2 as P,ff as O,k$ as G,aA as g,l0 as M,aV as k,c0 as T,d$ as B,l1 as L,l2 as H,l3 as A,l4 as Z,l5 as z,l6 as y,l7 as J,l8 as Y,l9 as b,H as w,dZ as K,N as v}from"./index-CfYeSufM.js";import{E as X}from"./constants-B4mRqufT.js";import{o as $}from"./floorFilterUtils-DZ5C6FQv.js";import{n as D,p as E}from"./popupUtils-DB8vJbLy.js";class ee{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(i=>i.currentUserRequired)}}visitClientWhereClause(i){i&&this._clauses.push(N(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,t){if(i&&t!=null)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(i,t){if(i)for(const e of(t==null?void 0:t.filters)??[])this.visitClientWhereClause(e.where)}visitFilter(i){this.visitClientWhereClause(i==null?void 0:i.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i==null?void 0:i.latestObservations.labelsVisible,i==null?void 0:i.latestObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.previousObservations.labelsVisible,i==null?void 0:i.previousObservations.labelingInfo),this.visitLabelingInfo(i==null?void 0:i.trackLines.labelsVisible,i==null?void 0:i.trackLines.labelingInfo))}}const se=x=>{let i=class extends x{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([V(()=>{var l,s,a,o,n;const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?(l=t.elevationInfo)==null?void 0:l.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,((s=e==null?void 0:e.requiredFieldsOptions)==null?void 0:s.featureTitleFields)&&t&&"featureTitleFields"in t&&t.featureTitleFields,((a=e==null?void 0:e.requiredFieldsOptions)==null?void 0:a.utilityNetworkFields)&&W(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,(t==null?void 0:t.type)==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&((n=(o=t.parentCompositeLayer.linkChart)==null?void 0:o.linkChartProperties.nonspatialDataDisplay)==null?void 0:n.mode),(t==null?void 0:t.type)==="parquet"&&t.popupTemplate]},()=>this._handleChange(),Q),I(()=>{var t;return(t=this.view)==null?void 0:t.floors},"change",()=>this._handleChange()),I(()=>{var t;return(t=this.layer.displayFilterInfo)==null?void 0:t.filters},"change",()=>this._handleChange()),I(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:l}=this;return"outFields"in t&&t.outFields?P(e,[...O(e,t.outFields),...l]):P(e,l)}get displayFilterEnabled(){var t,e;return(((t=this.view)==null?void 0:t.displayFilterEnabled)??!0)&&(!("displayFilterEnabled"in this.layer)||(((e=this.layer)==null?void 0:e.displayFilterEnabled)??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?G(t.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){g.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){var t;return(t=this.layer)!=null&&t.url?M(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){var l;const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new k(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=T(e.where,$(this))),this.displayFilterEnabled&&(e.where=T(e.where,(l=this.effectiveDisplayFilter)==null?void 0:l.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new k(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){return this._validateFetchPopupFeatures(t,e),this._fetchPopupFeatures(t,e)}_loadArcadeModules(t){var e;return(e=t.expressionInfos)!=null&&e.length||Array.isArray(t.content)&&t.content.some(l=>l.type==="expression")?B():Promise.resolve()}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",t),t.then(()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)}),t}async _updateClientWhereClauseRequirements(){var l;if(!this.layer||!this.view)return;const{layer:t}=this,e=new ee(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter((l=this.featureEffect)==null?void 0:l.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const s of t.sublayers)e.visitLabelingInfo(s.labelsVisible,s.labelingInfo);try{const s=await e.finish();this._set("requiresCurrentUser",s.requiresCurrentUser)}catch(s){g.getLogger(this).error(s)}}async _updateRequiredFields(){var m,_,q,R;if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:l,objectIdField:s}}=this,a="renderer"in e&&e.renderer,o="orderBy"in e&&e.orderBy,n="featureReduction"in e?e.featureReduction:null,r=new Set,f=[a?a.collectRequiredFields(r,l):null,L(r,e),t&&"elevationInfo"in e?H(r,e):null,this.filter!=null?A(r,e,this.filter):null,t||this.featureEffect==null?null:A(r,e,this.featureEffect.filter),!t&&n?Z(r,e,n):null,!t&&o?z(r,e,o):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&y(r,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:u}=e;y(r,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&u.timeField!=="startTimeField"||y(r,e.fieldsIndex,[e.timeInfo.startField]),u.timeField==="endTimeField"&&y(r,e.fieldsIndex,[e.timeInfo.endField]),await J(r,e)}if("floorInfo"in e&&e.floorInfo&&y(r,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&((_=(m=this.view)==null?void 0:m.requiredFieldsOptions)!=null&&_.featureTitleFields)&&e.featureTitleFields&&y(r,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&((R=(q=this.view)==null?void 0:q.requiredFieldsOptions)!=null&&R.globalIdField)&&y(r,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&f.push(Y(r,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&g.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),y(r,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){b(r,l,e.subtypeField);const u=e.sublayers.map(F=>{var C;return Promise.all([(C=F.renderer)==null?void 0:C.collectRequiredFields(r,l),L(r,F)])});f.push(Promise.all(u))}if(e.type==="catalog-footprint"&&e.parent){const u=e.parent;y(r,l,[u.itemNameField,u.itemSourceField,u.itemTypeField,u.maxScaleField,u.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&b(r,l,X),e.type==="parquet"&&f.push(D(e,e.popupTemplate).then(u=>{for(const F of u)r.add(F)}));const c=await Promise.allSettled(f);b(r,l,s),t&&"displayField"in e&&e.displayField&&b(r,l,e.displayField);for(const u of c)u.status==="rejected"&&g.getLogger(this).error(u.reason);const h=Array.from(r).sort();this._set("requiredFields",h)}_validateFetchPopupFeatures(t,e){if(e!=null)for(const l of t){const s=l.origin&&"layer"in l.origin?l.origin.layer:l.layer;if("popupEnabled"in s&&!s.popupEnabled)throw new w("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(l.isAggregate){const a="featureReduction"in s?s.featureReduction:null,o="trackInfo"in s?s.trackInfo:null;if(a==null&&o==null||a!=null&&(!("popupTemplate"in a)||!a.popupEnabled||!a.popupTemplate)||o!=null&&o.enabled&&(!("popupTemplate"in o)||!o.popupEnabled||!o.popupTemplate))throw new w("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!E(s,e))throw new w("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}_popupFeatureHasRequiredFields(t,e){return K(e,t)}async _fetchPopupFeatures(t,e){var o;const l=new Array(t.length),s=new Map,a=await this._createPopupQuery(t.map(n=>{var r;return((r=n.origin)==null?void 0:r.layer)??n.layer}),e);for(let n=0;n<t.length;n++){const r=t[n];if(r.isAggregate){l[n]=r;continue}const f=((o=r.origin)==null?void 0:o.layer)??r.layer;if(!f||!("popupEnabled"in f))continue;const c=O(this.layer.fieldsIndex,a.outFields),h=E(f,e);if(h==null)continue;const m=await this._loadArcadeModules(h);v(e),m&&m.arcadeUtils.hasGeometryOperations(h)||!this._popupFeatureHasRequiredFields(r,c)?s.set(r.getObjectId(),{graphic:r,index:n}):l[n]=r}if(this.layer.type==="stream"||this.layer.type==="parquet"||s.size===0)return l.filter(Boolean);a.objectIds=Array.from(s.keys());try{const n=await this.layer.queryFeatures(a,e);for(const r of n.features){const{graphic:{geometry:f,origin:c},index:h}=s.get(r.getObjectId());r.geometry||(r.geometry=f),r.origin=c,l[h]=r}}catch{}return l.filter(Boolean)}async _createPopupQuery(t,e){const l=this.layer.createQuery(),s=new Set;let a=!1;const o=t??[this.layer];for(const n of o){if(!("popupEnabled"in n))continue;const r=E(n,e);if(r==null)continue;const f=await this._loadArcadeModules(r);v(e);const c=f&&f.arcadeUtils.hasGeometryOperations(r);a=!(this.layer.geometryType!=="point"&&!c);const h=await D(this.layer,r);v(e);for(const m of h)s.add(m)}if(l.returnGeometry=a,l.returnZ=a,l.returnM=a,l.outFields=Array.from(s),l.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo){const n=$(this);n!=null&&(l.where=l.where?`(${l.where}) AND (${n})`:n)}return l}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return d([p()],i.prototype,"_updatingRequiredPromise",void 0),d([p({readOnly:!0})],i.prototype,"availableFields",null),d([p({readOnly:!0})],i.prototype,"displayFilterEnabled",null),d([p({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),d([p({type:U})],i.prototype,"featureEffect",null),d([p({type:S})],i.prototype,"filter",void 0),d([p()],i.prototype,"layer",void 0),d([p({type:Number})],i.prototype,"maximumNumberOfFeatures",null),d([p({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),d([p()],i.prototype,"requiresCurrentUser",void 0),d([p({readOnly:!0})],i.prototype,"requiredFields",void 0),d([p({readOnly:!0})],i.prototype,"signedInUser",null),d([p()],i.prototype,"suspended",void 0),d([p()],i.prototype,"view",void 0),i=d([j("esri.views.layers.FeatureLayerView")],i),i};export{se as U};
